2025-06-23 11:08:21,604 - DEBUG - Context after update: {'last_message': 'Dame todos los datos del 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-23 11:08:21,604 - INFO - User message: Dame todos los datos del 12345678A
2025-06-23 11:08:21,604 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-23 11:08:21,662 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-e022dad1-e980-4938-9fad-d849697e0639', 'json_data': {'messages': [{'role': 'system', 'content': 'Eres un asistente general. Responde preguntas comunes sin inventar datos. Si no aplican herramientas específicas, responde con conocimiento general. Utiliza siempre el  ultimo contexto disponible (como DNI, tipo de consulta, etc.) para responder o realizar llamadas a herramientas, especialmente en consultas referenciales.'}, {'role': 'user', 'content': 'Dame todos los datos del 12345678A'}], 'model': 'meta-llama/llama-4-scout-17b-16e-instruct', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': "Esta herramienta realiza la operación 'existe_abonado' en el endpoint '/existe_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': "Esta herramienta realiza la operación 'direccion_abonado' en el endpoint '/direccion_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': "Esta herramienta realiza la operación 'estado_pagos' en el endpoint '/estado_pagos' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': "Esta herramienta realiza la operación 'ultimo_pago' en el endpoint '/ultimo_pago' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': "Esta herramienta realiza la operación 'deuda_total' en el endpoint '/deuda_total' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': "Esta herramienta realiza la operación 'facturas_pendientes' en el endpoint '/facturas_pendientes' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': "Esta herramienta realiza la operación 'todas_las_facturas' en el endpoint '/todas_las_facturas' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': "Esta herramienta realiza la operación 'datos_abonado' en el endpoint '/datos_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': "Esta herramienta realiza la operación 'crear_incidencia' en el endpoint '/crear_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': "Esta herramienta realiza la operación 'incidencias_por_dni' en el endpoint '/incidencias_por_dni' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': "Esta herramienta realiza la operación 'incidencias_por_nombre' en el endpoint '/incidencias_por_nombre' usando el método 'POST.'", 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': "Esta herramienta realiza la operación 'actualizar_estado_incidencia' en el endpoint '/actualizar_estado_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': "Esta herramienta realiza la operación 'incidencias_pendientes' en el endpoint '/incidencias_pendientes' usando el método 'POST.'", 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': "Esta herramienta realiza la operación 'incidencias_por_ubicacion' en el endpoint '/incidencias_por_ubicacion' usando el método 'POST.'", 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': "Esta herramienta realiza la operación 'herramientas_disponibles' en el endpoint '/herramientas_disponibles' usando el método 'GET.'", 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-23 11:08:21,759 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-23 11:08:21,759 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-23 11:08:21,837 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA55D11D0>
2025-06-23 11:08:21,837 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001AAA54D1B50> server_hostname='api.groq.com' timeout=5.0
2025-06-23 11:08:21,869 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA55D1310>
2025-06-23 11:08:21,870 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 11:08:21,870 - DEBUG - send_request_headers.complete
2025-06-23 11:08:21,870 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 11:08:21,870 - DEBUG - send_request_body.complete
2025-06-23 11:08:21,871 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 11:08:22,187 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 23 Jun 2025 09:08:22 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'1000'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-requests', b'985'), (b'x-ratelimit-remaining-tokens', b'29901'), (b'x-ratelimit-reset-requests', b'20m45.344s'), (b'x-ratelimit-reset-tokens', b'198ms'), (b'x-request-id', b'req_01jye0qctrfasbrxqk7rtss863'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=Nhn.QJA4vkmaGQl3sncDlBQ9stzYUgFLzFZUOTtatOA-1750669702-1.0.1.1-56Ymk3I2KRvD6HAhHzUcP7i.DGXibyv.hOPopR6yl5tL4zrpm1G9YlNrrvyrvv1R3evv_ijbCoqy0KKIU97eIk6pvgYz8O1C_P2.u629870; path=/; expires=Mon, 23-Jun-25 09:38:22 GMT; domain=.groq.com; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9542d724cb3a0341-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-23 11:08:22,188 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-23 11:08:22,188 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 11:08:22,188 - DEBUG - receive_response_body.complete
2025-06-23 11:08:22,189 - DEBUG - response_closed.started
2025-06-23 11:08:22,189 - DEBUG - response_closed.complete
2025-06-23 11:08:22,189 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Mon, 23 Jun 2025 09:08:22 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '1000', 'x-ratelimit-limit-tokens': '30000', 'x-ratelimit-remaining-requests': '985', 'x-ratelimit-remaining-tokens': '29901', 'x-ratelimit-reset-requests': '20m45.344s', 'x-ratelimit-reset-tokens': '198ms', 'x-request-id': 'req_01jye0qctrfasbrxqk7rtss863', 'cf-cache-status': 'DYNAMIC', 'set-cookie': '__cf_bm=Nhn.QJA4vkmaGQl3sncDlBQ9stzYUgFLzFZUOTtatOA-1750669702-1.0.1.1-56Ymk3I2KRvD6HAhHzUcP7i.DGXibyv.hOPopR6yl5tL4zrpm1G9YlNrrvyrvv1R3evv_ijbCoqy0KKIU97eIk6pvgYz8O1C_P2.u629870; path=/; expires=Mon, 23-Jun-25 09:38:22 GMT; domain=.groq.com; HttpOnly; Secure; SameSite=None', 'server': 'cloudflare', 'cf-ray': '9542d724cb3a0341-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-23 11:08:22,191 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='fytxfvv03', function=Function(arguments='{"dni":"12345678A"}', name='datos_abonado'), type='function')])
2025-06-23 11:08:22,192 - INFO - Executing tool: datos_abonado with args: {'dni': '12345678A'}
2025-06-23 11:08:22,623 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 11:08:24,659 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA54635C0>
2025-06-23 11:08:24,660 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 11:08:24,660 - DEBUG - send_request_headers.complete
2025-06-23 11:08:24,660 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 11:08:24,660 - DEBUG - send_request_body.complete
2025-06-23 11:08:24,660 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 11:08:24,663 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 09:08:24 GMT'), (b'server', b'uvicorn'), (b'content-length', b'141'), (b'content-type', b'application/json')])
2025-06-23 11:08:24,663 - INFO - HTTP Request: POST http://localhost:8000/datos_abonado "HTTP/1.1 200 OK"
2025-06-23 11:08:24,664 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 11:08:24,664 - DEBUG - receive_response_body.complete
2025-06-23 11:08:24,664 - DEBUG - response_closed.started
2025-06-23 11:08:24,664 - DEBUG - response_closed.complete
2025-06-23 11:08:24,664 - DEBUG - close.started
2025-06-23 11:08:24,664 - DEBUG - close.complete
2025-06-23 11:08:24,664 - INFO - Raw tool response for datos_abonado: {'nombre': 'Juan Pérez', 'dni': '12345678A', 'direccion': 'Calle Falsa 123', 'correo': 'juan@example.com', 'telefono': '123456789', 'poliza': 'POL123'}
2025-06-23 11:08:24,664 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-23 11:08:24,664 - INFO - Final Markdown content: ### Datos del abonado
- **Nombre:** Juan Pérez
- **DNI:** 12345678A
- **Dirección:** Calle Falsa 123
- **Correo electrónico:** juan@example.com
- **Teléfono:** 123456789
- **Póliza:** POL123
2025-06-23 11:08:28,230 - DEBUG - Context after update: {'last_message': 'Y TODAS SUS FACTURAS', 'requires_real_data': True, 'is_referential': True, 'query_type': 'factura', 'dni': '12345678A'}
2025-06-23 11:08:28,230 - DEBUG - Referential prompt injected: Reference context: The previous DNI used in this conversation is 12345678A.
2025-06-23 11:08:28,230 - INFO - User message: Y TODAS SUS FACTURAS
2025-06-23 11:08:28,230 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-23 11:08:28,232 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-42ae2c8c-789f-4e01-8456-8193e428ff98', 'json_data': {'messages': [{'role': 'system', 'content': 'Eres un agente especializado en gestión de facturas. **No inventes datos**; utiliza herramientas para obtener información precisa. Si el usuario proporciona un DNI o ID de factura, llama a la herramienta correspondiente. Responde únicamente con los datos devueltos por la API en un formato claro y estructurado. Si no puedes encontrar datos, informa al usuario de manera transparente.'}, {'role': 'system', 'content': 'Reference context: The previous DNI used in this conversation is 12345678A.'}, {'role': 'user', 'content': 'Y TODAS SUS FACTURAS'}], 'model': 'meta-llama/llama-4-scout-17b-16e-instruct', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': "Esta herramienta realiza la operación 'existe_abonado' en el endpoint '/existe_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': "Esta herramienta realiza la operación 'direccion_abonado' en el endpoint '/direccion_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': "Esta herramienta realiza la operación 'estado_pagos' en el endpoint '/estado_pagos' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': "Esta herramienta realiza la operación 'ultimo_pago' en el endpoint '/ultimo_pago' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': "Esta herramienta realiza la operación 'deuda_total' en el endpoint '/deuda_total' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': "Esta herramienta realiza la operación 'facturas_pendientes' en el endpoint '/facturas_pendientes' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': "Esta herramienta realiza la operación 'todas_las_facturas' en el endpoint '/todas_las_facturas' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': "Esta herramienta realiza la operación 'datos_abonado' en el endpoint '/datos_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': "Esta herramienta realiza la operación 'crear_incidencia' en el endpoint '/crear_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': "Esta herramienta realiza la operación 'incidencias_por_dni' en el endpoint '/incidencias_por_dni' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': "Esta herramienta realiza la operación 'incidencias_por_nombre' en el endpoint '/incidencias_por_nombre' usando el método 'POST.'", 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': "Esta herramienta realiza la operación 'actualizar_estado_incidencia' en el endpoint '/actualizar_estado_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': "Esta herramienta realiza la operación 'incidencias_pendientes' en el endpoint '/incidencias_pendientes' usando el método 'POST.'", 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': "Esta herramienta realiza la operación 'incidencias_por_ubicacion' en el endpoint '/incidencias_por_ubicacion' usando el método 'POST.'", 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': "Esta herramienta realiza la operación 'herramientas_disponibles' en el endpoint '/herramientas_disponibles' usando el método 'GET.'", 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-23 11:08:28,233 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-23 11:08:28,233 - DEBUG - close.started
2025-06-23 11:08:28,234 - DEBUG - close.complete
2025-06-23 11:08:28,234 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-23 11:08:28,262 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA55F8D60>
2025-06-23 11:08:28,262 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001AAA54D1B50> server_hostname='api.groq.com' timeout=5.0
2025-06-23 11:08:28,298 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA551F1D0>
2025-06-23 11:08:28,298 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 11:08:28,298 - DEBUG - send_request_headers.complete
2025-06-23 11:08:28,298 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 11:08:28,298 - DEBUG - send_request_body.complete
2025-06-23 11:08:28,299 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 11:08:28,617 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 23 Jun 2025 09:08:28 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'1000'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-requests', b'984'), (b'x-ratelimit-remaining-tokens', b'29866'), (b'x-ratelimit-reset-requests', b'22m55.973999999s'), (b'x-ratelimit-reset-tokens', b'268ms'), (b'x-request-id', b'req_01jye0qk3jen781cta9sr9hdj1'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9542d74cfc0fcfaa-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-23 11:08:28,617 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-23 11:08:28,617 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 11:08:28,617 - DEBUG - receive_response_body.complete
2025-06-23 11:08:28,617 - DEBUG - response_closed.started
2025-06-23 11:08:28,618 - DEBUG - response_closed.complete
2025-06-23 11:08:28,618 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Mon, 23 Jun 2025 09:08:28 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '1000', 'x-ratelimit-limit-tokens': '30000', 'x-ratelimit-remaining-requests': '984', 'x-ratelimit-remaining-tokens': '29866', 'x-ratelimit-reset-requests': '22m55.973999999s', 'x-ratelimit-reset-tokens': '268ms', 'x-request-id': 'req_01jye0qk3jen781cta9sr9hdj1', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '9542d74cfc0fcfaa-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-23 11:08:28,618 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='40a9z3hrc', function=Function(arguments='{"dni":"12345678A"}', name='todas_las_facturas'), type='function')])
2025-06-23 11:08:28,618 - INFO - Executing tool: todas_las_facturas with args: {'dni': '12345678A'}
2025-06-23 11:08:29,033 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 11:08:31,109 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA55E48D0>
2025-06-23 11:08:31,110 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 11:08:31,110 - DEBUG - send_request_headers.complete
2025-06-23 11:08:31,110 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 11:08:31,110 - DEBUG - send_request_body.complete
2025-06-23 11:08:31,110 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 11:08:31,113 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 09:08:30 GMT'), (b'server', b'uvicorn'), (b'content-length', b'132'), (b'content-type', b'application/json')])
2025-06-23 11:08:31,114 - INFO - HTTP Request: POST http://localhost:8000/todas_las_facturas "HTTP/1.1 200 OK"
2025-06-23 11:08:31,114 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 11:08:31,114 - DEBUG - receive_response_body.complete
2025-06-23 11:08:31,114 - DEBUG - response_closed.started
2025-06-23 11:08:31,114 - DEBUG - response_closed.complete
2025-06-23 11:08:31,114 - DEBUG - close.started
2025-06-23 11:08:31,114 - DEBUG - close.complete
2025-06-23 11:08:31,114 - INFO - Raw tool response for todas_las_facturas: {'facturas': [{'fecha': '2025-06-10', 'estado': 'Pendiente', 'importe': 200.75}, {'fecha': '2025-06-01', 'estado': 'Pagado', 'importe': 100.5}]}
2025-06-23 11:08:31,114 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-23 11:08:31,115 - INFO - Final Markdown content: ### Facturas
| Fecha | Estado | Importe |
|:------|:--------|--------:|
| 2025-06-10 | Pendiente | 200.75  |
| 2025-06-01 | Pagado | 100.50  |

**Total pendiente:** 200.75 
2025-06-23 11:08:34,908 - DEBUG - Context after update: {'last_message': 'Dame todos los datos del 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-23 11:08:34,908 - INFO - User message: Dame todos los datos del 12345678A
2025-06-23 11:08:34,908 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-23 11:08:34,909 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-e24a70c9-8692-4db9-86e8-3a0073b189d2', 'json_data': {'messages': [{'role': 'system', 'content': 'Eres un asistente general. Responde preguntas comunes sin inventar datos. Si no aplican herramientas específicas, responde con conocimiento general. Utiliza siempre el  ultimo contexto disponible (como DNI, tipo de consulta, etc.) para responder o realizar llamadas a herramientas, especialmente en consultas referenciales.'}, {'role': 'user', 'content': 'Dame todos los datos del 12345678A'}], 'model': 'meta-llama/llama-4-scout-17b-16e-instruct', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': "Esta herramienta realiza la operación 'existe_abonado' en el endpoint '/existe_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': "Esta herramienta realiza la operación 'direccion_abonado' en el endpoint '/direccion_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': "Esta herramienta realiza la operación 'estado_pagos' en el endpoint '/estado_pagos' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': "Esta herramienta realiza la operación 'ultimo_pago' en el endpoint '/ultimo_pago' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': "Esta herramienta realiza la operación 'deuda_total' en el endpoint '/deuda_total' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': "Esta herramienta realiza la operación 'facturas_pendientes' en el endpoint '/facturas_pendientes' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': "Esta herramienta realiza la operación 'todas_las_facturas' en el endpoint '/todas_las_facturas' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': "Esta herramienta realiza la operación 'datos_abonado' en el endpoint '/datos_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': "Esta herramienta realiza la operación 'crear_incidencia' en el endpoint '/crear_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': "Esta herramienta realiza la operación 'incidencias_por_dni' en el endpoint '/incidencias_por_dni' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': "Esta herramienta realiza la operación 'incidencias_por_nombre' en el endpoint '/incidencias_por_nombre' usando el método 'POST.'", 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': "Esta herramienta realiza la operación 'actualizar_estado_incidencia' en el endpoint '/actualizar_estado_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': "Esta herramienta realiza la operación 'incidencias_pendientes' en el endpoint '/incidencias_pendientes' usando el método 'POST.'", 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': "Esta herramienta realiza la operación 'incidencias_por_ubicacion' en el endpoint '/incidencias_por_ubicacion' usando el método 'POST.'", 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': "Esta herramienta realiza la operación 'herramientas_disponibles' en el endpoint '/herramientas_disponibles' usando el método 'GET.'", 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-23 11:08:34,910 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-23 11:08:34,910 - DEBUG - close.started
2025-06-23 11:08:34,911 - DEBUG - close.complete
2025-06-23 11:08:34,911 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-23 11:08:34,955 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA55E4E20>
2025-06-23 11:08:34,956 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001AAA54D1B50> server_hostname='api.groq.com' timeout=5.0
2025-06-23 11:08:34,986 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA5608050>
2025-06-23 11:08:34,987 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 11:08:34,987 - DEBUG - send_request_headers.complete
2025-06-23 11:08:34,987 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 11:08:34,988 - DEBUG - send_request_body.complete
2025-06-23 11:08:34,988 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 11:08:35,232 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 23 Jun 2025 09:08:35 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'1000'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-requests', b'983'), (b'x-ratelimit-remaining-tokens', b'29901'), (b'x-ratelimit-reset-requests', b'24m22.169999999s'), (b'x-ratelimit-reset-tokens', b'198ms'), (b'x-request-id', b'req_01jye0qsjrf4y9xr1agdsxx3gv'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9542d776c9740144-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-23 11:08:35,232 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-23 11:08:35,232 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 11:08:35,233 - DEBUG - receive_response_body.complete
2025-06-23 11:08:35,233 - DEBUG - response_closed.started
2025-06-23 11:08:35,233 - DEBUG - response_closed.complete
2025-06-23 11:08:35,233 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Mon, 23 Jun 2025 09:08:35 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '1000', 'x-ratelimit-limit-tokens': '30000', 'x-ratelimit-remaining-requests': '983', 'x-ratelimit-remaining-tokens': '29901', 'x-ratelimit-reset-requests': '24m22.169999999s', 'x-ratelimit-reset-tokens': '198ms', 'x-request-id': 'req_01jye0qsjrf4y9xr1agdsxx3gv', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '9542d776c9740144-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-23 11:08:35,233 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='wpkn8hzpx', function=Function(arguments='{"dni":"12345678A"}', name='datos_abonado'), type='function')])
2025-06-23 11:08:35,233 - INFO - Executing tool: datos_abonado with args: {'dni': '12345678A'}
2025-06-23 11:08:35,639 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 11:08:37,677 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA5608450>
2025-06-23 11:08:37,677 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 11:08:37,678 - DEBUG - send_request_headers.complete
2025-06-23 11:08:37,678 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 11:08:37,678 - DEBUG - send_request_body.complete
2025-06-23 11:08:37,678 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 11:08:37,681 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 09:08:37 GMT'), (b'server', b'uvicorn'), (b'content-length', b'141'), (b'content-type', b'application/json')])
2025-06-23 11:08:37,681 - INFO - HTTP Request: POST http://localhost:8000/datos_abonado "HTTP/1.1 200 OK"
2025-06-23 11:08:37,682 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 11:08:37,682 - DEBUG - receive_response_body.complete
2025-06-23 11:08:37,682 - DEBUG - response_closed.started
2025-06-23 11:08:37,682 - DEBUG - response_closed.complete
2025-06-23 11:08:37,682 - DEBUG - close.started
2025-06-23 11:08:37,682 - DEBUG - close.complete
2025-06-23 11:08:37,682 - INFO - Raw tool response for datos_abonado: {'nombre': 'Juan Pérez', 'dni': '12345678A', 'direccion': 'Calle Falsa 123', 'correo': 'juan@example.com', 'telefono': '123456789', 'poliza': 'POL123'}
2025-06-23 11:08:37,682 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-23 11:08:37,682 - INFO - Final Markdown content: ### Datos del abonado
- **Nombre:** Juan Pérez
- **DNI:** 12345678A
- **Dirección:** Calle Falsa 123
- **Correo electrónico:** juan@example.com
- **Teléfono:** 123456789
- **Póliza:** POL123
2025-06-23 11:08:38,126 - DEBUG - Context after update: {'last_message': 'todas sus facturas', 'requires_real_data': True, 'is_referential': True, 'query_type': 'factura', 'dni': '12345678A'}
2025-06-23 11:08:38,126 - DEBUG - Referential prompt injected: Reference context: The previous DNI used in this conversation is 12345678A.
2025-06-23 11:08:38,126 - INFO - User message: todas sus facturas
2025-06-23 11:08:38,127 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-23 11:08:38,128 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-9a58f834-2f50-438d-92bb-5be8f8697587', 'json_data': {'messages': [{'role': 'system', 'content': 'Eres un agente especializado en gestión de facturas. **No inventes datos**; utiliza herramientas para obtener información precisa. Si el usuario proporciona un DNI o ID de factura, llama a la herramienta correspondiente. Responde únicamente con los datos devueltos por la API en un formato claro y estructurado. Si no puedes encontrar datos, informa al usuario de manera transparente.'}, {'role': 'system', 'content': 'Reference context: The previous DNI used in this conversation is 12345678A.'}, {'role': 'user', 'content': 'todas sus facturas'}], 'model': 'meta-llama/llama-4-scout-17b-16e-instruct', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': "Esta herramienta realiza la operación 'existe_abonado' en el endpoint '/existe_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': "Esta herramienta realiza la operación 'direccion_abonado' en el endpoint '/direccion_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': "Esta herramienta realiza la operación 'estado_pagos' en el endpoint '/estado_pagos' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': "Esta herramienta realiza la operación 'ultimo_pago' en el endpoint '/ultimo_pago' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': "Esta herramienta realiza la operación 'deuda_total' en el endpoint '/deuda_total' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': "Esta herramienta realiza la operación 'facturas_pendientes' en el endpoint '/facturas_pendientes' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': "Esta herramienta realiza la operación 'todas_las_facturas' en el endpoint '/todas_las_facturas' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': "Esta herramienta realiza la operación 'datos_abonado' en el endpoint '/datos_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': "Esta herramienta realiza la operación 'crear_incidencia' en el endpoint '/crear_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': "Esta herramienta realiza la operación 'incidencias_por_dni' en el endpoint '/incidencias_por_dni' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': "Esta herramienta realiza la operación 'incidencias_por_nombre' en el endpoint '/incidencias_por_nombre' usando el método 'POST.'", 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': "Esta herramienta realiza la operación 'actualizar_estado_incidencia' en el endpoint '/actualizar_estado_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': "Esta herramienta realiza la operación 'incidencias_pendientes' en el endpoint '/incidencias_pendientes' usando el método 'POST.'", 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': "Esta herramienta realiza la operación 'incidencias_por_ubicacion' en el endpoint '/incidencias_por_ubicacion' usando el método 'POST.'", 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': "Esta herramienta realiza la operación 'herramientas_disponibles' en el endpoint '/herramientas_disponibles' usando el método 'GET.'", 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-23 11:08:38,129 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-23 11:08:38,129 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 11:08:38,130 - DEBUG - send_request_headers.complete
2025-06-23 11:08:38,130 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 11:08:38,130 - DEBUG - send_request_body.complete
2025-06-23 11:08:38,130 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 11:08:38,388 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 23 Jun 2025 09:08:38 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'1000'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-requests', b'982'), (b'x-ratelimit-remaining-tokens', b'29350'), (b'x-ratelimit-reset-requests', b'25m52.058s'), (b'x-ratelimit-reset-tokens', b'1.299s'), (b'x-request-id', b'req_01jye0qwmyf52b3nmwxjhj8q24'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9542d78a6f6f0144-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-23 11:08:38,388 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-23 11:08:38,388 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 11:08:38,389 - DEBUG - receive_response_body.complete
2025-06-23 11:08:38,389 - DEBUG - response_closed.started
2025-06-23 11:08:38,389 - DEBUG - response_closed.complete
2025-06-23 11:08:38,389 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Mon, 23 Jun 2025 09:08:38 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '1000', 'x-ratelimit-limit-tokens': '30000', 'x-ratelimit-remaining-requests': '982', 'x-ratelimit-remaining-tokens': '29350', 'x-ratelimit-reset-requests': '25m52.058s', 'x-ratelimit-reset-tokens': '1.299s', 'x-request-id': 'req_01jye0qwmyf52b3nmwxjhj8q24', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '9542d78a6f6f0144-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-23 11:08:38,389 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='wskvg24s0', function=Function(arguments='{"dni":"12345678A"}', name='todas_las_facturas'), type='function')])
2025-06-23 11:08:38,389 - INFO - Executing tool: todas_las_facturas with args: {'dni': '12345678A'}
2025-06-23 11:08:38,795 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 11:08:40,860 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA5555400>
2025-06-23 11:08:40,860 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 11:08:40,861 - DEBUG - send_request_headers.complete
2025-06-23 11:08:40,861 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 11:08:40,862 - DEBUG - send_request_body.complete
2025-06-23 11:08:40,862 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 11:08:40,864 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 09:08:40 GMT'), (b'server', b'uvicorn'), (b'content-length', b'132'), (b'content-type', b'application/json')])
2025-06-23 11:08:40,865 - INFO - HTTP Request: POST http://localhost:8000/todas_las_facturas "HTTP/1.1 200 OK"
2025-06-23 11:08:40,865 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 11:08:40,865 - DEBUG - receive_response_body.complete
2025-06-23 11:08:40,865 - DEBUG - response_closed.started
2025-06-23 11:08:40,865 - DEBUG - response_closed.complete
2025-06-23 11:08:40,865 - DEBUG - close.started
2025-06-23 11:08:40,865 - DEBUG - close.complete
2025-06-23 11:08:40,865 - INFO - Raw tool response for todas_las_facturas: {'facturas': [{'fecha': '2025-06-10', 'estado': 'Pendiente', 'importe': 200.75}, {'fecha': '2025-06-01', 'estado': 'Pagado', 'importe': 100.5}]}
2025-06-23 11:08:40,865 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-23 11:08:40,865 - INFO - Final Markdown content: ### Facturas
| Fecha | Estado | Importe |
|:------|:--------|--------:|
| 2025-06-10 | Pendiente | 200.75  |
| 2025-06-01 | Pagado | 100.50  |

**Total pendiente:** 200.75 
2025-06-23 11:08:43,952 - DEBUG - Context after update: {'last_message': 'todas sus incidencias', 'requires_real_data': False, 'is_referential': True, 'query_type': 'factura', 'dni': '12345678A'}
2025-06-23 11:08:43,953 - DEBUG - Referential prompt injected: Reference context: The previous DNI used in this conversation is 12345678A.
2025-06-23 11:08:43,953 - INFO - User message: todas sus incidencias
2025-06-23 11:08:43,953 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-23 11:08:43,954 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-914b24a2-3bd0-4de8-b56c-91b89e891a05', 'json_data': {'messages': [{'role': 'system', 'content': 'Eres un agente especializado en gestión de facturas. **No inventes datos**; utiliza herramientas para obtener información precisa. Si el usuario proporciona un DNI o ID de factura, llama a la herramienta correspondiente. Responde únicamente con los datos devueltos por la API en un formato claro y estructurado. Si no puedes encontrar datos, informa al usuario de manera transparente.'}, {'role': 'system', 'content': 'Reference context: The previous DNI used in this conversation is 12345678A.'}, {'role': 'user', 'content': 'todas sus incidencias'}], 'model': 'meta-llama/llama-4-scout-17b-16e-instruct', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': "Esta herramienta realiza la operación 'existe_abonado' en el endpoint '/existe_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': "Esta herramienta realiza la operación 'direccion_abonado' en el endpoint '/direccion_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': "Esta herramienta realiza la operación 'estado_pagos' en el endpoint '/estado_pagos' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': "Esta herramienta realiza la operación 'ultimo_pago' en el endpoint '/ultimo_pago' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': "Esta herramienta realiza la operación 'deuda_total' en el endpoint '/deuda_total' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': "Esta herramienta realiza la operación 'facturas_pendientes' en el endpoint '/facturas_pendientes' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': "Esta herramienta realiza la operación 'todas_las_facturas' en el endpoint '/todas_las_facturas' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': "Esta herramienta realiza la operación 'datos_abonado' en el endpoint '/datos_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': "Esta herramienta realiza la operación 'crear_incidencia' en el endpoint '/crear_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': "Esta herramienta realiza la operación 'incidencias_por_dni' en el endpoint '/incidencias_por_dni' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': "Esta herramienta realiza la operación 'incidencias_por_nombre' en el endpoint '/incidencias_por_nombre' usando el método 'POST.'", 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': "Esta herramienta realiza la operación 'actualizar_estado_incidencia' en el endpoint '/actualizar_estado_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': "Esta herramienta realiza la operación 'incidencias_pendientes' en el endpoint '/incidencias_pendientes' usando el método 'POST.'", 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': "Esta herramienta realiza la operación 'incidencias_por_ubicacion' en el endpoint '/incidencias_por_ubicacion' usando el método 'POST.'", 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': "Esta herramienta realiza la operación 'herramientas_disponibles' en el endpoint '/herramientas_disponibles' usando el método 'GET.'", 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-23 11:08:43,955 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-23 11:08:43,955 - DEBUG - close.started
2025-06-23 11:08:43,955 - DEBUG - close.complete
2025-06-23 11:08:43,955 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-23 11:08:43,983 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA5555A90>
2025-06-23 11:08:43,983 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001AAA54D1B50> server_hostname='api.groq.com' timeout=5.0
2025-06-23 11:08:44,017 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA55B7690>
2025-06-23 11:08:44,017 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 11:08:44,017 - DEBUG - send_request_headers.complete
2025-06-23 11:08:44,017 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 11:08:44,017 - DEBUG - send_request_body.complete
2025-06-23 11:08:44,017 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 11:08:44,272 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 23 Jun 2025 09:08:44 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'1000'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-requests', b'981'), (b'x-ratelimit-remaining-tokens', b'29866'), (b'x-ratelimit-reset-requests', b'27m15.712s'), (b'x-ratelimit-reset-tokens', b'268ms'), (b'x-request-id', b'req_01jye0r2cyenv9cbq1z6ve0yex'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9542d7af389d0424-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-23 11:08:44,273 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-23 11:08:44,273 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 11:08:44,273 - DEBUG - receive_response_body.complete
2025-06-23 11:08:44,273 - DEBUG - response_closed.started
2025-06-23 11:08:44,273 - DEBUG - response_closed.complete
2025-06-23 11:08:44,273 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Mon, 23 Jun 2025 09:08:44 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '1000', 'x-ratelimit-limit-tokens': '30000', 'x-ratelimit-remaining-requests': '981', 'x-ratelimit-remaining-tokens': '29866', 'x-ratelimit-reset-requests': '27m15.712s', 'x-ratelimit-reset-tokens': '268ms', 'x-request-id': 'req_01jye0r2cyenv9cbq1z6ve0yex', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '9542d7af389d0424-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-23 11:08:44,274 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='d7mnd2y5t', function=Function(arguments='{"dni":"12345678A"}', name='incidencias_por_dni'), type='function')])
2025-06-23 11:08:44,274 - INFO - Executing tool: incidencias_por_dni with args: {'dni': '12345678A'}
2025-06-23 11:08:44,577 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 11:08:46,627 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA55B7D90>
2025-06-23 11:08:46,628 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 11:08:46,628 - DEBUG - send_request_headers.complete
2025-06-23 11:08:46,628 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 11:08:46,628 - DEBUG - send_request_body.complete
2025-06-23 11:08:46,628 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 11:08:46,633 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 09:08:45 GMT'), (b'server', b'uvicorn'), (b'content-length', b'424'), (b'content-type', b'application/json')])
2025-06-23 11:08:46,633 - INFO - HTTP Request: POST http://localhost:8000/incidencias_por_dni "HTTP/1.1 200 OK"
2025-06-23 11:08:46,633 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 11:08:46,633 - DEBUG - receive_response_body.complete
2025-06-23 11:08:46,633 - DEBUG - response_closed.started
2025-06-23 11:08:46,633 - DEBUG - response_closed.complete
2025-06-23 11:08:46,633 - DEBUG - close.started
2025-06-23 11:08:46,634 - DEBUG - close.complete
2025-06-23 11:08:46,634 - INFO - Raw tool response for incidencias_por_dni: {'incidencias': [{'ubicacion': 'Madrid', 'descripcion': 'Fallo en el suministro eléctrico', 'estado': 'Abierto'}, {'ubicacion': 'Zihuatanejo', 'descripcion': 'cortes de suministro de agua', 'estado': 'Abierto'}, {'ubicacion': 'Zihuatanejo', 'descripcion': 'cortes de suministro de agua', 'estado': 'Abierto'}, {'ubicacion': 'albacete', 'descripcion': 'rafagas de viento', 'estado': 'Abierto'}, {'ubicacion': '', 'descripcion': '', 'estado': 'Abierto'}]}
2025-06-23 11:08:46,634 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-23 11:08:46,634 - INFO - Final Markdown content: ### Incidencias del usuario 

**Estado actual de sus incidencias:**
- Total: 5 incidencia(s)
- Abiertas: 5
- En proceso: 0
- Resueltas: 0

**Tiene incidencias abiertas pendientes de resolución**

#### Lista detallada de incidencias
| Ubicación | Descripción | Estado |
|:----------|:------------|:-------|
| Madrid | Fallo en el suministro eléctrico | Abierto |
| Zihuatanejo | cortes de suministro de agua | Abierto |
| Zihuatanejo | cortes de suministro de agua | Abierto |
| albacete | rafagas de viento | Abierto |
|  |  | Abierto |
2025-06-23 11:08:51,887 - DEBUG - close.started
2025-06-23 11:08:51,888 - DEBUG - close.complete

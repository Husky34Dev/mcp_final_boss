2025-06-23 14:16:50,280 - DEBUG - Context after update: {'last_message': 'hola, dame los datos del abonado con dni 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-23 14:16:50,280 - INFO - User message: hola, dame los datos del abonado con dni 12345678A
2025-06-23 14:16:50,280 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-23 14:16:50,362 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-25bee923-3157-4e95-8a37-d619597bc92c', 'json_data': {'messages': [{'role': 'system', 'content': 'Eres un asistente general. Responde preguntas comunes sin inventar datos. Si no aplican herramientas específicas, responde con conocimiento general. Utiliza siempre el  ultimo contexto disponible (como DNI, tipo de consulta, etc.) para responder o realizar llamadas a herramientas, especialmente en consultas referenciales.'}, {'role': 'user', 'content': 'hola, dame los datos del abonado con dni 12345678A'}], 'model': 'meta-llama/llama-4-scout-17b-16e-instruct', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': "Esta herramienta realiza la operación 'existe_abonado' en el endpoint '/existe_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': "Esta herramienta realiza la operación 'direccion_abonado' en el endpoint '/direccion_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': "Esta herramienta realiza la operación 'estado_pagos' en el endpoint '/estado_pagos' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': "Esta herramienta realiza la operación 'ultimo_pago' en el endpoint '/ultimo_pago' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': "Esta herramienta realiza la operación 'deuda_total' en el endpoint '/deuda_total' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': "Esta herramienta realiza la operación 'facturas_pendientes' en el endpoint '/facturas_pendientes' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': "Esta herramienta realiza la operación 'todas_las_facturas' en el endpoint '/todas_las_facturas' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': "Esta herramienta realiza la operación 'datos_abonado' en el endpoint '/datos_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': "Esta herramienta realiza la operación 'crear_incidencia' en el endpoint '/crear_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': "Esta herramienta realiza la operación 'incidencias_por_dni' en el endpoint '/incidencias_por_dni' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': "Esta herramienta realiza la operación 'incidencias_por_nombre' en el endpoint '/incidencias_por_nombre' usando el método 'POST.'", 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': "Esta herramienta realiza la operación 'actualizar_estado_incidencia' en el endpoint '/actualizar_estado_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': "Esta herramienta realiza la operación 'incidencias_pendientes' en el endpoint '/incidencias_pendientes' usando el método 'POST.'", 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': "Esta herramienta realiza la operación 'incidencias_por_ubicacion' en el endpoint '/incidencias_por_ubicacion' usando el método 'POST.'", 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': "Esta herramienta realiza la operación 'herramientas_disponibles' en el endpoint '/herramientas_disponibles' usando el método 'GET.'", 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-23 14:16:50,486 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-23 14:16:50,486 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:16:50,539 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C27EC851D0>
2025-06-23 14:16:50,539 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001C27EB81C70> server_hostname='api.groq.com' timeout=5.0
2025-06-23 14:16:50,576 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C27EC85310>
2025-06-23 14:16:50,577 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:16:50,577 - DEBUG - send_request_headers.complete
2025-06-23 14:16:50,578 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:16:50,578 - DEBUG - send_request_body.complete
2025-06-23 14:16:50,579 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:16:51,115 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 23 Jun 2025 12:16:50 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'1000'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-requests', b'998'), (b'x-ratelimit-remaining-tokens', b'29897'), (b'x-ratelimit-reset-requests', b'2m39.338s'), (b'x-ratelimit-reset-tokens', b'206ms'), (b'x-request-id', b'req_01jyebgghxfzs8eg9mc4yp8zxg'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=kOYCKdZhg1OdRDXfnpweEBzfBnZVcxGTgFKXe3sgss0-1750681010-1.0.1.1-JzAgNjNg09tD6YXGCd7yabBX9j6YCV5Vsn0QFSRti1kMylmFvFdBMCp9xlXvk3_.IzVvFXHHG5c3AfabFZ41S9H7sTXgRxF_YOJ5_a0VTS4; path=/; expires=Mon, 23-Jun-25 12:46:50 GMT; domain=.groq.com; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9543eb3ce9a45e12-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-23 14:16:51,116 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-23 14:16:51,117 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:16:51,117 - DEBUG - receive_response_body.complete
2025-06-23 14:16:51,117 - DEBUG - response_closed.started
2025-06-23 14:16:51,117 - DEBUG - response_closed.complete
2025-06-23 14:16:51,117 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Mon, 23 Jun 2025 12:16:50 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '1000', 'x-ratelimit-limit-tokens': '30000', 'x-ratelimit-remaining-requests': '998', 'x-ratelimit-remaining-tokens': '29897', 'x-ratelimit-reset-requests': '2m39.338s', 'x-ratelimit-reset-tokens': '206ms', 'x-request-id': 'req_01jyebgghxfzs8eg9mc4yp8zxg', 'cf-cache-status': 'DYNAMIC', 'set-cookie': '__cf_bm=kOYCKdZhg1OdRDXfnpweEBzfBnZVcxGTgFKXe3sgss0-1750681010-1.0.1.1-JzAgNjNg09tD6YXGCd7yabBX9j6YCV5Vsn0QFSRti1kMylmFvFdBMCp9xlXvk3_.IzVvFXHHG5c3AfabFZ41S9H7sTXgRxF_YOJ5_a0VTS4; path=/; expires=Mon, 23-Jun-25 12:46:50 GMT; domain=.groq.com; HttpOnly; Secure; SameSite=None', 'server': 'cloudflare', 'cf-ray': '9543eb3ce9a45e12-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-23 14:16:51,121 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='t1vn1pz6c', function=Function(arguments='{"dni":"12345678A"}', name='datos_abonado'), type='function')])
2025-06-23 14:16:51,121 - INFO - Executing tool: datos_abonado with args: {'dni': '12345678A'}
2025-06-23 14:16:51,681 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:16:53,750 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C27EB136F0>
2025-06-23 14:16:53,750 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:16:53,751 - DEBUG - send_request_headers.complete
2025-06-23 14:16:53,751 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:16:53,751 - DEBUG - send_request_body.complete
2025-06-23 14:16:53,751 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:16:53,756 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:16:53 GMT'), (b'server', b'uvicorn'), (b'content-length', b'141'), (b'content-type', b'application/json')])
2025-06-23 14:16:53,756 - INFO - HTTP Request: POST http://localhost:8000/datos_abonado "HTTP/1.1 200 OK"
2025-06-23 14:16:53,756 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:16:53,756 - DEBUG - receive_response_body.complete
2025-06-23 14:16:53,756 - DEBUG - response_closed.started
2025-06-23 14:16:53,756 - DEBUG - response_closed.complete
2025-06-23 14:16:53,756 - DEBUG - close.started
2025-06-23 14:16:53,757 - DEBUG - close.complete
2025-06-23 14:16:53,757 - INFO - Raw tool response for datos_abonado: {'nombre': 'Juan Pérez', 'dni': '12345678A', 'direccion': 'Calle Falsa 123', 'correo': 'juan@example.com', 'telefono': '123456789', 'poliza': 'POL123'}
2025-06-23 14:16:53,757 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-23 14:16:53,757 - INFO - Final Markdown content: ### Datos del abonado
- **Nombre:** Juan Pérez
- **DNI:** 12345678A
- **Dirección:** Calle Falsa 123
- **Correo electrónico:** juan@example.com
- **Teléfono:** 123456789
- **Póliza:** POL123
2025-06-23 14:16:54,505 - DEBUG - Context after update: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada', 'requires_real_data': True, 'is_referential': False, 'query_type': 'incidencia_creacion', 'dni': '12345678A', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada'}
2025-06-23 14:16:54,506 - INFO - User message: crea una incidencia en Huelva, furgoneta averiada
2025-06-23 14:16:54,506 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-23 14:16:54,508 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-2c05add7-16c3-443a-82bf-8b0650aa7b67', 'json_data': {'messages': [{'role': 'system', 'content': "Eres un agente especializado en gestión de incidencias. **No inventes datos**; extrae el DNI o ID de incidencia y llama a la herramienta correcta. Presenta sólo los datos reales obtenidos de la API. No llames a herramientas de abonado como direccion_abonado para consultas de incidencias. \n\nCuando te pregunten por una ubicación, usa siempre incidencias_por_ubicacion. Si la pregunta es referencial (ejemplo: 'Y en Barcelona?'), significa que el usuario quiere consultar las incidencias en esa nueva ubicación. Asegúrate de que las consultas referenciales con ubicación generen siempre una llamada a la herramienta adecuada."}, {'role': 'user', 'content': 'crea una incidencia en Huelva, furgoneta averiada'}], 'model': 'meta-llama/llama-4-scout-17b-16e-instruct', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': "Esta herramienta realiza la operación 'existe_abonado' en el endpoint '/existe_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': "Esta herramienta realiza la operación 'direccion_abonado' en el endpoint '/direccion_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': "Esta herramienta realiza la operación 'estado_pagos' en el endpoint '/estado_pagos' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': "Esta herramienta realiza la operación 'ultimo_pago' en el endpoint '/ultimo_pago' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': "Esta herramienta realiza la operación 'deuda_total' en el endpoint '/deuda_total' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': "Esta herramienta realiza la operación 'facturas_pendientes' en el endpoint '/facturas_pendientes' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': "Esta herramienta realiza la operación 'todas_las_facturas' en el endpoint '/todas_las_facturas' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': "Esta herramienta realiza la operación 'datos_abonado' en el endpoint '/datos_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': "Esta herramienta realiza la operación 'crear_incidencia' en el endpoint '/crear_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': "Esta herramienta realiza la operación 'incidencias_por_dni' en el endpoint '/incidencias_por_dni' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': "Esta herramienta realiza la operación 'incidencias_por_nombre' en el endpoint '/incidencias_por_nombre' usando el método 'POST.'", 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': "Esta herramienta realiza la operación 'actualizar_estado_incidencia' en el endpoint '/actualizar_estado_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': "Esta herramienta realiza la operación 'incidencias_pendientes' en el endpoint '/incidencias_pendientes' usando el método 'POST.'", 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': "Esta herramienta realiza la operación 'incidencias_por_ubicacion' en el endpoint '/incidencias_por_ubicacion' usando el método 'POST.'", 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': "Esta herramienta realiza la operación 'herramientas_disponibles' en el endpoint '/herramientas_disponibles' usando el método 'GET.'", 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-23 14:16:54,510 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-23 14:16:54,511 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:16:54,512 - DEBUG - send_request_headers.complete
2025-06-23 14:16:54,512 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:16:54,513 - DEBUG - send_request_body.complete
2025-06-23 14:16:54,513 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:16:55,413 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 23 Jun 2025 12:16:55 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'1000'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-requests', b'997'), (b'x-ratelimit-remaining-tokens', b'29681'), (b'x-ratelimit-reset-requests', b'4m15.269s'), (b'x-ratelimit-reset-tokens', b'638ms'), (b'x-request-id', b'req_01jyebgmcrfzwap1dj764cvc20'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9543eb557b645e12-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-23 14:16:55,414 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-23 14:16:55,414 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:16:55,415 - DEBUG - receive_response_body.complete
2025-06-23 14:16:55,415 - DEBUG - response_closed.started
2025-06-23 14:16:55,415 - DEBUG - response_closed.complete
2025-06-23 14:16:55,415 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Mon, 23 Jun 2025 12:16:55 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '1000', 'x-ratelimit-limit-tokens': '30000', 'x-ratelimit-remaining-requests': '997', 'x-ratelimit-remaining-tokens': '29681', 'x-ratelimit-reset-requests': '4m15.269s', 'x-ratelimit-reset-tokens': '638ms', 'x-request-id': 'req_01jyebgmcrfzwap1dj764cvc20', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '9543eb557b645e12-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-23 14:16:55,416 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='3nx455ewt', function=Function(arguments='{"descripcion":"furgoneta averiada","dni":"","ubicacion":"Huelva"}', name='crear_incidencia'), type='function')])
2025-06-23 14:16:55,416 - INFO - Executing tool: crear_incidencia with args: {'descripcion': 'furgoneta averiada', 'dni': '', 'ubicacion': 'Huelva'}
2025-06-23 14:16:55,962 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:16:57,999 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C27ECAA190>
2025-06-23 14:16:57,999 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:16:58,000 - DEBUG - send_request_headers.complete
2025-06-23 14:16:58,000 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:16:58,000 - DEBUG - send_request_body.complete
2025-06-23 14:16:58,000 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:16:58,006 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:16:57 GMT'), (b'server', b'uvicorn'), (b'content-length', b'64'), (b'content-type', b'application/json')])
2025-06-23 14:16:58,006 - INFO - HTTP Request: POST http://localhost:8000/crear_incidencia "HTTP/1.1 200 OK"
2025-06-23 14:16:58,006 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:16:58,007 - DEBUG - receive_response_body.complete
2025-06-23 14:16:58,007 - DEBUG - response_closed.started
2025-06-23 14:16:58,007 - DEBUG - response_closed.complete
2025-06-23 14:16:58,007 - DEBUG - close.started
2025-06-23 14:16:58,007 - DEBUG - close.complete
2025-06-23 14:16:58,007 - INFO - Raw tool response for crear_incidencia: {'error': 'No se encontró un abonado con el DNI proporcionado.'}
2025-06-23 14:16:58,007 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-23 14:16:58,008 - INFO - Final Markdown content: No se pudo crear la incidencia.
2025-06-23 14:17:46,857 - DEBUG - close.started
2025-06-23 14:17:46,859 - DEBUG - close.complete
2025-06-23 14:17:49,166 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:17:51,195 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000013BC8A59160>
2025-06-23 14:17:51,195 - DEBUG - send_request_headers.started request=<Request [b'GET']>
2025-06-23 14:17:51,196 - DEBUG - send_request_headers.complete
2025-06-23 14:17:51,196 - DEBUG - send_request_body.started request=<Request [b'GET']>
2025-06-23 14:17:51,196 - DEBUG - send_request_body.complete
2025-06-23 14:17:51,196 - DEBUG - receive_response_headers.started request=<Request [b'GET']>
2025-06-23 14:17:51,215 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:17:50 GMT'), (b'server', b'uvicorn'), (b'content-length', b'9382'), (b'content-type', b'application/json')])
2025-06-23 14:17:51,215 - INFO - HTTP Request: GET http://localhost:8000/openapi.json "HTTP/1.1 200 OK"
2025-06-23 14:17:51,215 - DEBUG - receive_response_body.started request=<Request [b'GET']>
2025-06-23 14:17:51,215 - DEBUG - receive_response_body.complete
2025-06-23 14:17:51,215 - DEBUG - response_closed.started
2025-06-23 14:17:51,215 - DEBUG - response_closed.complete
2025-06-23 14:17:51,215 - DEBUG - close.started
2025-06-23 14:17:51,216 - DEBUG - close.complete
2025-06-23 14:18:01,976 - DEBUG - Initial context before applying field rules: {'last_message': 'hola, dame los datos del abonado con dni 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-23 14:18:01,976 - DEBUG - Context after update: {'last_message': 'hola, dame los datos del abonado con dni 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-23 14:18:01,977 - INFO - User message: hola, dame los datos del abonado con dni 12345678A
2025-06-23 14:18:01,977 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-23 14:18:02,074 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-7730b84d-6e75-406d-b609-3a2d77a72dca', 'json_data': {'messages': [{'role': 'system', 'content': 'Eres un asistente general. Responde preguntas comunes sin inventar datos. Si no aplican herramientas específicas, responde con conocimiento general. Utiliza siempre el  ultimo contexto disponible (como DNI, tipo de consulta, etc.) para responder o realizar llamadas a herramientas, especialmente en consultas referenciales.'}, {'role': 'user', 'content': 'hola, dame los datos del abonado con dni 12345678A'}], 'model': 'meta-llama/llama-4-scout-17b-16e-instruct', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': "Esta herramienta realiza la operación 'existe_abonado' en el endpoint '/existe_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': "Esta herramienta realiza la operación 'direccion_abonado' en el endpoint '/direccion_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': "Esta herramienta realiza la operación 'estado_pagos' en el endpoint '/estado_pagos' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': "Esta herramienta realiza la operación 'ultimo_pago' en el endpoint '/ultimo_pago' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': "Esta herramienta realiza la operación 'deuda_total' en el endpoint '/deuda_total' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': "Esta herramienta realiza la operación 'facturas_pendientes' en el endpoint '/facturas_pendientes' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': "Esta herramienta realiza la operación 'todas_las_facturas' en el endpoint '/todas_las_facturas' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': "Esta herramienta realiza la operación 'datos_abonado' en el endpoint '/datos_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': "Esta herramienta realiza la operación 'crear_incidencia' en el endpoint '/crear_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': "Esta herramienta realiza la operación 'incidencias_por_dni' en el endpoint '/incidencias_por_dni' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': "Esta herramienta realiza la operación 'incidencias_por_nombre' en el endpoint '/incidencias_por_nombre' usando el método 'POST.'", 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': "Esta herramienta realiza la operación 'actualizar_estado_incidencia' en el endpoint '/actualizar_estado_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': "Esta herramienta realiza la operación 'incidencias_pendientes' en el endpoint '/incidencias_pendientes' usando el método 'POST.'", 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': "Esta herramienta realiza la operación 'incidencias_por_ubicacion' en el endpoint '/incidencias_por_ubicacion' usando el método 'POST.'", 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': "Esta herramienta realiza la operación 'herramientas_disponibles' en el endpoint '/herramientas_disponibles' usando el método 'GET.'", 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-23 14:18:02,226 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-23 14:18:02,226 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:18:02,292 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000013BC8B051D0>
2025-06-23 14:18:02,292 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000013BC8A01C70> server_hostname='api.groq.com' timeout=5.0
2025-06-23 14:18:02,332 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000013BC8B05310>
2025-06-23 14:18:02,332 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:18:02,333 - DEBUG - send_request_headers.complete
2025-06-23 14:18:02,333 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:18:02,334 - DEBUG - send_request_body.complete
2025-06-23 14:18:02,334 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:18:03,306 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 23 Jun 2025 12:18:03 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'1000'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-requests', b'996'), (b'x-ratelimit-remaining-tokens', b'29897'), (b'x-ratelimit-reset-requests', b'4m37.765s'), (b'x-ratelimit-reset-tokens', b'206ms'), (b'x-request-id', b'req_01jyebjpm5eef9pygws4v9eh9t'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=1t99ZJMmHvu4.deA196yLLXzbdbw.I2lm1LC.DuMfn8-1750681083-1.0.1.1-O1IcvwIdqVKd2jUoRGKkkclZC0FrpMxSVvRfGpvxgrepC1x923GBejLJRww4Y0Qjq7suMbtZ5Gje20NvZ2wM46szgVMoFvtD.5tPMEdtT04; path=/; expires=Mon, 23-Jun-25 12:48:03 GMT; domain=.groq.com; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9543ecfd58746689-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-23 14:18:03,307 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-23 14:18:03,307 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:18:03,308 - DEBUG - receive_response_body.complete
2025-06-23 14:18:03,308 - DEBUG - response_closed.started
2025-06-23 14:18:03,308 - DEBUG - response_closed.complete
2025-06-23 14:18:03,308 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Mon, 23 Jun 2025 12:18:03 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '1000', 'x-ratelimit-limit-tokens': '30000', 'x-ratelimit-remaining-requests': '996', 'x-ratelimit-remaining-tokens': '29897', 'x-ratelimit-reset-requests': '4m37.765s', 'x-ratelimit-reset-tokens': '206ms', 'x-request-id': 'req_01jyebjpm5eef9pygws4v9eh9t', 'cf-cache-status': 'DYNAMIC', 'set-cookie': '__cf_bm=1t99ZJMmHvu4.deA196yLLXzbdbw.I2lm1LC.DuMfn8-1750681083-1.0.1.1-O1IcvwIdqVKd2jUoRGKkkclZC0FrpMxSVvRfGpvxgrepC1x923GBejLJRww4Y0Qjq7suMbtZ5Gje20NvZ2wM46szgVMoFvtD.5tPMEdtT04; path=/; expires=Mon, 23-Jun-25 12:48:03 GMT; domain=.groq.com; HttpOnly; Secure; SameSite=None', 'server': 'cloudflare', 'cf-ray': '9543ecfd58746689-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-23 14:18:03,311 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='vdbf8ff5c', function=Function(arguments='{"dni":"12345678A"}', name='datos_abonado'), type='function')])
2025-06-23 14:18:03,311 - INFO - Executing tool: datos_abonado with args: {'dni': '12345678A'}
2025-06-23 14:18:03,809 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:18:05,861 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000013BC89936F0>
2025-06-23 14:18:05,861 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:18:05,862 - DEBUG - send_request_headers.complete
2025-06-23 14:18:05,862 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:18:05,862 - DEBUG - send_request_body.complete
2025-06-23 14:18:05,862 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:18:05,870 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:18:05 GMT'), (b'server', b'uvicorn'), (b'content-length', b'141'), (b'content-type', b'application/json')])
2025-06-23 14:18:05,871 - INFO - HTTP Request: POST http://localhost:8000/datos_abonado "HTTP/1.1 200 OK"
2025-06-23 14:18:05,871 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:18:05,871 - DEBUG - receive_response_body.complete
2025-06-23 14:18:05,871 - DEBUG - response_closed.started
2025-06-23 14:18:05,871 - DEBUG - response_closed.complete
2025-06-23 14:18:05,871 - DEBUG - close.started
2025-06-23 14:18:05,871 - DEBUG - close.complete
2025-06-23 14:18:05,871 - INFO - Raw tool response for datos_abonado: {'nombre': 'Juan Pérez', 'dni': '12345678A', 'direccion': 'Calle Falsa 123', 'correo': 'juan@example.com', 'telefono': '123456789', 'poliza': 'POL123'}
2025-06-23 14:18:05,872 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-23 14:18:05,872 - INFO - Final Markdown content: ### Datos del abonado
- **Nombre:** Juan Pérez
- **DNI:** 12345678A
- **Dirección:** Calle Falsa 123
- **Correo electrónico:** juan@example.com
- **Teléfono:** 123456789
- **Póliza:** POL123
2025-06-23 14:18:07,066 - DEBUG - Initial context before applying field rules: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada', 'requires_real_data': True, 'is_referential': False, 'query_type': 'incidencia_creacion', 'dni': '12345678A', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada'}
2025-06-23 14:18:07,066 - DEBUG - Context after update: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada', 'requires_real_data': True, 'is_referential': False, 'query_type': 'incidencia_creacion', 'dni': '12345678A', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada'}
2025-06-23 14:18:07,066 - INFO - User message: crea una incidencia en Huelva, furgoneta averiada
2025-06-23 14:18:07,067 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-23 14:18:07,069 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-7ea3458b-a183-403d-b18a-184a67c73045', 'json_data': {'messages': [{'role': 'system', 'content': "Eres un agente especializado en gestión de incidencias. **No inventes datos**; extrae el DNI o ID de incidencia y llama a la herramienta correcta. Presenta sólo los datos reales obtenidos de la API. No llames a herramientas de abonado como direccion_abonado para consultas de incidencias. \n\nCuando te pregunten por una ubicación, usa siempre incidencias_por_ubicacion. Si la pregunta es referencial (ejemplo: 'Y en Barcelona?'), significa que el usuario quiere consultar las incidencias en esa nueva ubicación. Asegúrate de que las consultas referenciales con ubicación generen siempre una llamada a la herramienta adecuada."}, {'role': 'user', 'content': 'crea una incidencia en Huelva, furgoneta averiada'}], 'model': 'meta-llama/llama-4-scout-17b-16e-instruct', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': "Esta herramienta realiza la operación 'existe_abonado' en el endpoint '/existe_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': "Esta herramienta realiza la operación 'direccion_abonado' en el endpoint '/direccion_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': "Esta herramienta realiza la operación 'estado_pagos' en el endpoint '/estado_pagos' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': "Esta herramienta realiza la operación 'ultimo_pago' en el endpoint '/ultimo_pago' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': "Esta herramienta realiza la operación 'deuda_total' en el endpoint '/deuda_total' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': "Esta herramienta realiza la operación 'facturas_pendientes' en el endpoint '/facturas_pendientes' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': "Esta herramienta realiza la operación 'todas_las_facturas' en el endpoint '/todas_las_facturas' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': "Esta herramienta realiza la operación 'datos_abonado' en el endpoint '/datos_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': "Esta herramienta realiza la operación 'crear_incidencia' en el endpoint '/crear_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': "Esta herramienta realiza la operación 'incidencias_por_dni' en el endpoint '/incidencias_por_dni' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': "Esta herramienta realiza la operación 'incidencias_por_nombre' en el endpoint '/incidencias_por_nombre' usando el método 'POST.'", 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': "Esta herramienta realiza la operación 'actualizar_estado_incidencia' en el endpoint '/actualizar_estado_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': "Esta herramienta realiza la operación 'incidencias_pendientes' en el endpoint '/incidencias_pendientes' usando el método 'POST.'", 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': "Esta herramienta realiza la operación 'incidencias_por_ubicacion' en el endpoint '/incidencias_por_ubicacion' usando el método 'POST.'", 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': "Esta herramienta realiza la operación 'herramientas_disponibles' en el endpoint '/herramientas_disponibles' usando el método 'GET.'", 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-23 14:18:07,072 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-23 14:18:07,072 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:18:07,073 - DEBUG - send_request_headers.complete
2025-06-23 14:18:07,073 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:18:07,074 - DEBUG - send_request_body.complete
2025-06-23 14:18:07,074 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:18:08,347 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 23 Jun 2025 12:18:08 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'1000'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-requests', b'995'), (b'x-ratelimit-remaining-tokens', b'29742'), (b'x-ratelimit-reset-requests', b'7m7.284s'), (b'x-ratelimit-reset-tokens', b'516ms'), (b'x-request-id', b'req_01jyebjv80eeqv3p81mdt5qdb8'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9543ed1afdcb6689-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-23 14:18:08,348 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-23 14:18:08,349 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:18:08,349 - DEBUG - receive_response_body.complete
2025-06-23 14:18:08,350 - DEBUG - response_closed.started
2025-06-23 14:18:08,350 - DEBUG - response_closed.complete
2025-06-23 14:18:08,350 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Mon, 23 Jun 2025 12:18:08 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '1000', 'x-ratelimit-limit-tokens': '30000', 'x-ratelimit-remaining-requests': '995', 'x-ratelimit-remaining-tokens': '29742', 'x-ratelimit-reset-requests': '7m7.284s', 'x-ratelimit-reset-tokens': '516ms', 'x-request-id': 'req_01jyebjv80eeqv3p81mdt5qdb8', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '9543ed1afdcb6689-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-23 14:18:08,351 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='5n6a279kn', function=Function(arguments='{"descripcion":"furgoneta averiada","dni":"","estado":"Abierto","ubicacion":"Huelva"}', name='crear_incidencia'), type='function')])
2025-06-23 14:18:08,351 - INFO - Executing tool: crear_incidencia with args: {'descripcion': 'furgoneta averiada', 'dni': '', 'estado': 'Abierto', 'ubicacion': 'Huelva'}
2025-06-23 14:18:08,918 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:18:10,975 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000013BC8B2A190>
2025-06-23 14:18:10,976 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:18:10,976 - DEBUG - send_request_headers.complete
2025-06-23 14:18:10,976 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:18:10,976 - DEBUG - send_request_body.complete
2025-06-23 14:18:10,976 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:18:10,982 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:18:10 GMT'), (b'server', b'uvicorn'), (b'content-length', b'64'), (b'content-type', b'application/json')])
2025-06-23 14:18:10,982 - INFO - HTTP Request: POST http://localhost:8000/crear_incidencia "HTTP/1.1 200 OK"
2025-06-23 14:18:10,983 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:18:10,983 - DEBUG - receive_response_body.complete
2025-06-23 14:18:10,983 - DEBUG - response_closed.started
2025-06-23 14:18:10,983 - DEBUG - response_closed.complete
2025-06-23 14:18:10,983 - DEBUG - close.started
2025-06-23 14:18:10,983 - DEBUG - close.complete
2025-06-23 14:18:10,983 - INFO - Raw tool response for crear_incidencia: {'error': 'No se encontró un abonado con el DNI proporcionado.'}
2025-06-23 14:18:10,983 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-23 14:18:10,984 - INFO - Final Markdown content: No se pudo crear la incidencia.
2025-06-23 14:19:01,757 - DEBUG - close.started
2025-06-23 14:19:01,759 - DEBUG - close.complete
2025-06-23 14:19:04,042 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:19:06,110 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000209CEE59400>
2025-06-23 14:19:06,111 - DEBUG - send_request_headers.started request=<Request [b'GET']>
2025-06-23 14:19:06,111 - DEBUG - send_request_headers.complete
2025-06-23 14:19:06,111 - DEBUG - send_request_body.started request=<Request [b'GET']>
2025-06-23 14:19:06,111 - DEBUG - send_request_body.complete
2025-06-23 14:19:06,112 - DEBUG - receive_response_headers.started request=<Request [b'GET']>
2025-06-23 14:19:06,129 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:19:05 GMT'), (b'server', b'uvicorn'), (b'content-length', b'9382'), (b'content-type', b'application/json')])
2025-06-23 14:19:06,130 - INFO - HTTP Request: GET http://localhost:8000/openapi.json "HTTP/1.1 200 OK"
2025-06-23 14:19:06,130 - DEBUG - receive_response_body.started request=<Request [b'GET']>
2025-06-23 14:19:06,130 - DEBUG - receive_response_body.complete
2025-06-23 14:19:06,130 - DEBUG - response_closed.started
2025-06-23 14:19:06,130 - DEBUG - response_closed.complete
2025-06-23 14:19:06,130 - DEBUG - close.started
2025-06-23 14:19:06,130 - DEBUG - close.complete
2025-06-23 14:19:16,729 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:19:18,787 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000028E8B8F9400>
2025-06-23 14:19:18,788 - DEBUG - send_request_headers.started request=<Request [b'GET']>
2025-06-23 14:19:18,788 - DEBUG - send_request_headers.complete
2025-06-23 14:19:18,788 - DEBUG - send_request_body.started request=<Request [b'GET']>
2025-06-23 14:19:18,788 - DEBUG - send_request_body.complete
2025-06-23 14:19:18,788 - DEBUG - receive_response_headers.started request=<Request [b'GET']>
2025-06-23 14:19:18,802 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:19:18 GMT'), (b'server', b'uvicorn'), (b'content-length', b'9382'), (b'content-type', b'application/json')])
2025-06-23 14:19:18,803 - INFO - HTTP Request: GET http://localhost:8000/openapi.json "HTTP/1.1 200 OK"
2025-06-23 14:19:18,803 - DEBUG - receive_response_body.started request=<Request [b'GET']>
2025-06-23 14:19:18,803 - DEBUG - receive_response_body.complete
2025-06-23 14:19:18,803 - DEBUG - response_closed.started
2025-06-23 14:19:18,803 - DEBUG - response_closed.complete
2025-06-23 14:19:18,803 - DEBUG - close.started
2025-06-23 14:19:18,803 - DEBUG - close.complete
2025-06-23 14:19:30,036 - DEBUG - Initial context before applying field rules: {'last_message': 'hola, dame los datos del abonado con dni 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-23 14:19:30,036 - DEBUG - Applying field rules: {'inherit': ['dni'], 'remove': []}
2025-06-23 14:19:30,036 - DEBUG - Context after applying removal rules: {'last_message': 'hola, dame los datos del abonado con dni 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-23 14:19:30,036 - WARNING - Field dni not found in previous context, skipping inheritance
2025-06-23 14:19:30,037 - DEBUG - Context after applying inheritance rules: {'last_message': 'hola, dame los datos del abonado con dni 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-23 14:19:30,037 - DEBUG - Context after update: {'last_message': 'hola, dame los datos del abonado con dni 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-23 14:19:30,037 - INFO - User message: hola, dame los datos del abonado con dni 12345678A
2025-06-23 14:19:30,037 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-23 14:19:30,123 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-dfd03eb3-cc91-4f88-acec-2d081e994e26', 'json_data': {'messages': [{'role': 'system', 'content': 'Eres un asistente general. Responde preguntas comunes sin inventar datos. Si no aplican herramientas específicas, responde con conocimiento general. Utiliza siempre el  ultimo contexto disponible (como DNI, tipo de consulta, etc.) para responder o realizar llamadas a herramientas, especialmente en consultas referenciales.'}, {'role': 'user', 'content': 'hola, dame los datos del abonado con dni 12345678A'}], 'model': 'meta-llama/llama-4-scout-17b-16e-instruct', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': "Esta herramienta realiza la operación 'existe_abonado' en el endpoint '/existe_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': "Esta herramienta realiza la operación 'direccion_abonado' en el endpoint '/direccion_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': "Esta herramienta realiza la operación 'estado_pagos' en el endpoint '/estado_pagos' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': "Esta herramienta realiza la operación 'ultimo_pago' en el endpoint '/ultimo_pago' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': "Esta herramienta realiza la operación 'deuda_total' en el endpoint '/deuda_total' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': "Esta herramienta realiza la operación 'facturas_pendientes' en el endpoint '/facturas_pendientes' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': "Esta herramienta realiza la operación 'todas_las_facturas' en el endpoint '/todas_las_facturas' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': "Esta herramienta realiza la operación 'datos_abonado' en el endpoint '/datos_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': "Esta herramienta realiza la operación 'crear_incidencia' en el endpoint '/crear_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': "Esta herramienta realiza la operación 'incidencias_por_dni' en el endpoint '/incidencias_por_dni' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': "Esta herramienta realiza la operación 'incidencias_por_nombre' en el endpoint '/incidencias_por_nombre' usando el método 'POST.'", 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': "Esta herramienta realiza la operación 'actualizar_estado_incidencia' en el endpoint '/actualizar_estado_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': "Esta herramienta realiza la operación 'incidencias_pendientes' en el endpoint '/incidencias_pendientes' usando el método 'POST.'", 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': "Esta herramienta realiza la operación 'incidencias_por_ubicacion' en el endpoint '/incidencias_por_ubicacion' usando el método 'POST.'", 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': "Esta herramienta realiza la operación 'herramientas_disponibles' en el endpoint '/herramientas_disponibles' usando el método 'GET.'", 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-23 14:19:30,229 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-23 14:19:30,230 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:19:30,293 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000028E8B9A51D0>
2025-06-23 14:19:30,293 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000028E8B8A5BE0> server_hostname='api.groq.com' timeout=5.0
2025-06-23 14:19:30,325 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000028E8B9A5310>
2025-06-23 14:19:30,325 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:19:30,325 - DEBUG - send_request_headers.complete
2025-06-23 14:19:30,326 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:19:30,326 - DEBUG - send_request_body.complete
2025-06-23 14:19:30,326 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:19:31,063 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 23 Jun 2025 12:19:31 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'1000'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-requests', b'994'), (b'x-ratelimit-remaining-tokens', b'29897'), (b'x-ratelimit-reset-requests', b'7m15.076s'), (b'x-ratelimit-reset-tokens', b'206ms'), (b'x-request-id', b'req_01jyebncksensaq608h834xnyq'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=WO6Z7EEljcGhFRy6f2nhyYRx4vUepTGRuw.u5kdjgAE-1750681171-1.0.1.1-whDHtFbgxAPxM1VYrhAOGdxvTtqY59sASx4fMALmX86OUQrsQXikeKJ5XLp.6QpdO_LsXhtTUMa4H2RNmPFSRce144WP6o4i1HtGsujdGvY; path=/; expires=Mon, 23-Jun-25 12:49:31 GMT; domain=.groq.com; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9543ef2349c9cfda-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-23 14:19:31,064 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-23 14:19:31,064 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:19:31,065 - DEBUG - receive_response_body.complete
2025-06-23 14:19:31,065 - DEBUG - response_closed.started
2025-06-23 14:19:31,065 - DEBUG - response_closed.complete
2025-06-23 14:19:31,066 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Mon, 23 Jun 2025 12:19:31 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '1000', 'x-ratelimit-limit-tokens': '30000', 'x-ratelimit-remaining-requests': '994', 'x-ratelimit-remaining-tokens': '29897', 'x-ratelimit-reset-requests': '7m15.076s', 'x-ratelimit-reset-tokens': '206ms', 'x-request-id': 'req_01jyebncksensaq608h834xnyq', 'cf-cache-status': 'DYNAMIC', 'set-cookie': '__cf_bm=WO6Z7EEljcGhFRy6f2nhyYRx4vUepTGRuw.u5kdjgAE-1750681171-1.0.1.1-whDHtFbgxAPxM1VYrhAOGdxvTtqY59sASx4fMALmX86OUQrsQXikeKJ5XLp.6QpdO_LsXhtTUMa4H2RNmPFSRce144WP6o4i1HtGsujdGvY; path=/; expires=Mon, 23-Jun-25 12:49:31 GMT; domain=.groq.com; HttpOnly; Secure; SameSite=None', 'server': 'cloudflare', 'cf-ray': '9543ef2349c9cfda-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-23 14:19:31,070 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='jbxkxbsgs', function=Function(arguments='{"dni":"12345678A"}', name='datos_abonado'), type='function')])
2025-06-23 14:19:31,070 - INFO - Executing tool: datos_abonado with args: {'dni': '12345678A'}
2025-06-23 14:19:31,589 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:19:33,642 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000028E8B833360>
2025-06-23 14:19:33,642 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:19:33,643 - DEBUG - send_request_headers.complete
2025-06-23 14:19:33,643 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:19:33,643 - DEBUG - send_request_body.complete
2025-06-23 14:19:33,644 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:19:33,649 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:19:32 GMT'), (b'server', b'uvicorn'), (b'content-length', b'141'), (b'content-type', b'application/json')])
2025-06-23 14:19:33,649 - INFO - HTTP Request: POST http://localhost:8000/datos_abonado "HTTP/1.1 200 OK"
2025-06-23 14:19:33,649 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:19:33,650 - DEBUG - receive_response_body.complete
2025-06-23 14:19:33,650 - DEBUG - response_closed.started
2025-06-23 14:19:33,650 - DEBUG - response_closed.complete
2025-06-23 14:19:33,650 - DEBUG - close.started
2025-06-23 14:19:33,650 - DEBUG - close.complete
2025-06-23 14:19:33,650 - INFO - Raw tool response for datos_abonado: {'nombre': 'Juan Pérez', 'dni': '12345678A', 'direccion': 'Calle Falsa 123', 'correo': 'juan@example.com', 'telefono': '123456789', 'poliza': 'POL123'}
2025-06-23 14:19:33,650 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-23 14:19:33,650 - INFO - Final Markdown content: ### Datos del abonado
- **Nombre:** Juan Pérez
- **DNI:** 12345678A
- **Dirección:** Calle Falsa 123
- **Correo electrónico:** juan@example.com
- **Teléfono:** 123456789
- **Póliza:** POL123
2025-06-23 14:19:34,235 - DEBUG - Initial context before applying field rules: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada', 'requires_real_data': True, 'is_referential': False, 'query_type': 'incidencia_creacion', 'dni': '12345678A', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada'}
2025-06-23 14:19:34,235 - DEBUG - Applying field rules: {'inherit': [], 'remove': ['dni']}
2025-06-23 14:19:34,235 - DEBUG - Removing field: dni from context
2025-06-23 14:19:34,235 - DEBUG - Context after applying removal rules: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada', 'requires_real_data': True, 'is_referential': False, 'query_type': 'incidencia_creacion', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada'}
2025-06-23 14:19:34,235 - DEBUG - Context after applying inheritance rules: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada', 'requires_real_data': True, 'is_referential': False, 'query_type': 'incidencia_creacion', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada'}
2025-06-23 14:19:34,235 - DEBUG - Context after update: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada', 'requires_real_data': True, 'is_referential': False, 'query_type': 'incidencia_creacion', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada'}
2025-06-23 14:19:34,235 - WARNING - Missing context fields: {'dni': 'Perdona, ha habido un fallo: no pude identificar tu DNI. Por favor, reformula tu consulta incluyendo el DNI u otro dato clave.'}
2025-06-23 14:19:55,521 - DEBUG - Initial context before applying field rules: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada para el usuario 12345678A', 'requires_real_data': True, 'is_referential': True, 'query_type': 'incidencia_creacion', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada para el usuario 12345678A', 'dni': '12345678A'}
2025-06-23 14:19:55,521 - DEBUG - Applying field rules: {'inherit': [], 'remove': ['dni']}
2025-06-23 14:19:55,522 - DEBUG - Removing field: dni from context
2025-06-23 14:19:55,522 - DEBUG - Context after applying removal rules: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada para el usuario 12345678A', 'requires_real_data': True, 'is_referential': True, 'query_type': 'incidencia_creacion', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada para el usuario 12345678A'}
2025-06-23 14:19:55,522 - DEBUG - Context after applying inheritance rules: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada para el usuario 12345678A', 'requires_real_data': True, 'is_referential': True, 'query_type': 'incidencia_creacion', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada para el usuario 12345678A'}
2025-06-23 14:19:55,522 - DEBUG - Context after update: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada para el usuario 12345678A', 'requires_real_data': True, 'is_referential': True, 'query_type': 'incidencia_creacion', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada para el usuario 12345678A'}
2025-06-23 14:19:55,522 - WARNING - Missing context fields: {'dni': 'Perdona, ha habido un fallo: no pude identificar tu DNI. Por favor, reformula tu consulta incluyendo el DNI u otro dato clave.'}
2025-06-23 14:21:43,876 - DEBUG - close.started
2025-06-23 14:21:43,877 - DEBUG - close.complete
2025-06-23 14:21:46,315 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:21:48,378 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000017972A69160>
2025-06-23 14:21:48,378 - DEBUG - send_request_headers.started request=<Request [b'GET']>
2025-06-23 14:21:48,379 - DEBUG - send_request_headers.complete
2025-06-23 14:21:48,379 - DEBUG - send_request_body.started request=<Request [b'GET']>
2025-06-23 14:21:48,379 - DEBUG - send_request_body.complete
2025-06-23 14:21:48,379 - DEBUG - receive_response_headers.started request=<Request [b'GET']>
2025-06-23 14:21:48,396 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:21:47 GMT'), (b'server', b'uvicorn'), (b'content-length', b'9382'), (b'content-type', b'application/json')])
2025-06-23 14:21:48,396 - INFO - HTTP Request: GET http://localhost:8000/openapi.json "HTTP/1.1 200 OK"
2025-06-23 14:21:48,396 - DEBUG - receive_response_body.started request=<Request [b'GET']>
2025-06-23 14:21:48,396 - DEBUG - receive_response_body.complete
2025-06-23 14:21:48,397 - DEBUG - response_closed.started
2025-06-23 14:21:48,397 - DEBUG - response_closed.complete
2025-06-23 14:21:48,397 - DEBUG - close.started
2025-06-23 14:21:48,397 - DEBUG - close.complete
2025-06-23 14:22:23,691 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:22:25,742 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000022DCFA19160>
2025-06-23 14:22:25,743 - DEBUG - send_request_headers.started request=<Request [b'GET']>
2025-06-23 14:22:25,743 - DEBUG - send_request_headers.complete
2025-06-23 14:22:25,743 - DEBUG - send_request_body.started request=<Request [b'GET']>
2025-06-23 14:22:25,743 - DEBUG - send_request_body.complete
2025-06-23 14:22:25,743 - DEBUG - receive_response_headers.started request=<Request [b'GET']>
2025-06-23 14:22:25,760 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:22:24 GMT'), (b'server', b'uvicorn'), (b'content-length', b'9382'), (b'content-type', b'application/json')])
2025-06-23 14:22:25,761 - INFO - HTTP Request: GET http://localhost:8000/openapi.json "HTTP/1.1 200 OK"
2025-06-23 14:22:25,761 - DEBUG - receive_response_body.started request=<Request [b'GET']>
2025-06-23 14:22:25,761 - DEBUG - receive_response_body.complete
2025-06-23 14:22:25,761 - DEBUG - response_closed.started
2025-06-23 14:22:25,761 - DEBUG - response_closed.complete
2025-06-23 14:22:25,761 - DEBUG - close.started
2025-06-23 14:22:25,761 - DEBUG - close.complete
2025-06-23 14:22:32,793 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:22:34,829 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001A838C19160>
2025-06-23 14:22:34,830 - DEBUG - send_request_headers.started request=<Request [b'GET']>
2025-06-23 14:22:34,830 - DEBUG - send_request_headers.complete
2025-06-23 14:22:34,831 - DEBUG - send_request_body.started request=<Request [b'GET']>
2025-06-23 14:22:34,831 - DEBUG - send_request_body.complete
2025-06-23 14:22:34,831 - DEBUG - receive_response_headers.started request=<Request [b'GET']>
2025-06-23 14:22:34,858 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:22:34 GMT'), (b'server', b'uvicorn'), (b'content-length', b'9382'), (b'content-type', b'application/json')])
2025-06-23 14:22:34,859 - INFO - HTTP Request: GET http://localhost:8000/openapi.json "HTTP/1.1 200 OK"
2025-06-23 14:22:34,859 - DEBUG - receive_response_body.started request=<Request [b'GET']>
2025-06-23 14:22:34,860 - DEBUG - receive_response_body.complete
2025-06-23 14:22:34,860 - DEBUG - response_closed.started
2025-06-23 14:22:34,860 - DEBUG - response_closed.complete
2025-06-23 14:22:34,860 - DEBUG - close.started
2025-06-23 14:22:34,860 - DEBUG - close.complete
2025-06-23 14:23:04,132 - DEBUG - Initial context before applying field rules: {'last_message': 'hola, dame los datos del abonado con dni 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-23 14:23:04,133 - DEBUG - Applying field rules: {'inherit': ['dni'], 'remove': []}
2025-06-23 14:23:04,133 - DEBUG - Context after applying removal rules: {'last_message': 'hola, dame los datos del abonado con dni 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-23 14:23:04,133 - WARNING - Field dni not found in previous context, skipping inheritance
2025-06-23 14:23:04,133 - DEBUG - Context after applying inheritance rules: {'last_message': 'hola, dame los datos del abonado con dni 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-23 14:23:04,133 - DEBUG - Context after update: {'last_message': 'hola, dame los datos del abonado con dni 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-23 14:23:04,133 - INFO - User message: hola, dame los datos del abonado con dni 12345678A
2025-06-23 14:23:04,134 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-23 14:23:04,241 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-565a8041-ea75-42af-89e4-8e869952c74a', 'json_data': {'messages': [{'role': 'system', 'content': 'Eres un asistente general. Responde preguntas comunes sin inventar datos. Si no aplican herramientas específicas, responde con conocimiento general. Utiliza siempre el  ultimo contexto disponible (como DNI, tipo de consulta, etc.) para responder o realizar llamadas a herramientas, especialmente en consultas referenciales.'}, {'role': 'user', 'content': 'hola, dame los datos del abonado con dni 12345678A'}], 'model': 'meta-llama/llama-4-scout-17b-16e-instruct', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': "Esta herramienta realiza la operación 'existe_abonado' en el endpoint '/existe_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': "Esta herramienta realiza la operación 'direccion_abonado' en el endpoint '/direccion_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': "Esta herramienta realiza la operación 'estado_pagos' en el endpoint '/estado_pagos' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': "Esta herramienta realiza la operación 'ultimo_pago' en el endpoint '/ultimo_pago' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': "Esta herramienta realiza la operación 'deuda_total' en el endpoint '/deuda_total' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': "Esta herramienta realiza la operación 'facturas_pendientes' en el endpoint '/facturas_pendientes' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': "Esta herramienta realiza la operación 'todas_las_facturas' en el endpoint '/todas_las_facturas' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': "Esta herramienta realiza la operación 'datos_abonado' en el endpoint '/datos_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': "Esta herramienta realiza la operación 'crear_incidencia' en el endpoint '/crear_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': "Esta herramienta realiza la operación 'incidencias_por_dni' en el endpoint '/incidencias_por_dni' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': "Esta herramienta realiza la operación 'incidencias_por_nombre' en el endpoint '/incidencias_por_nombre' usando el método 'POST.'", 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': "Esta herramienta realiza la operación 'actualizar_estado_incidencia' en el endpoint '/actualizar_estado_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': "Esta herramienta realiza la operación 'incidencias_pendientes' en el endpoint '/incidencias_pendientes' usando el método 'POST.'", 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': "Esta herramienta realiza la operación 'incidencias_por_ubicacion' en el endpoint '/incidencias_por_ubicacion' usando el método 'POST.'", 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': "Esta herramienta realiza la operación 'herramientas_disponibles' en el endpoint '/herramientas_disponibles' usando el método 'GET.'", 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-23 14:23:04,381 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-23 14:23:04,381 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:23:04,441 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001A838CC51D0>
2025-06-23 14:23:04,441 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001A838BC1D90> server_hostname='api.groq.com' timeout=5.0
2025-06-23 14:23:04,475 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001A838CC5310>
2025-06-23 14:23:04,475 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:23:04,476 - DEBUG - send_request_headers.complete
2025-06-23 14:23:04,476 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:23:04,476 - DEBUG - send_request_body.complete
2025-06-23 14:23:04,476 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:23:04,882 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 23 Jun 2025 12:23:04 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'1000'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-requests', b'995'), (b'x-ratelimit-remaining-tokens', b'29897'), (b'x-ratelimit-reset-requests', b'6m30.702999999s'), (b'x-ratelimit-reset-tokens', b'206ms'), (b'x-request-id', b'req_01jyebvxpef0rvv8nfkfkze4vs'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=WpPlTBs80gujOfjh6.oDplVqE3t4i3oBZ0T5KTLrmF4-1750681384-1.0.1.1-mlhE9FuNfaQ7RiQ6aVG8mzhanMfqlzoOUgkrif2IkQgUxldxs3pxZ760ybXx4ur_MfFA23ffuHo93nA2MRnVp8CiI9m4i_j1zDE2Iyc5suA; path=/; expires=Mon, 23-Jun-25 12:53:04 GMT; domain=.groq.com; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9543f45dbe226665-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-23 14:23:04,884 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-23 14:23:04,884 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:23:04,885 - DEBUG - receive_response_body.complete
2025-06-23 14:23:04,885 - DEBUG - response_closed.started
2025-06-23 14:23:04,885 - DEBUG - response_closed.complete
2025-06-23 14:23:04,886 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Mon, 23 Jun 2025 12:23:04 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '1000', 'x-ratelimit-limit-tokens': '30000', 'x-ratelimit-remaining-requests': '995', 'x-ratelimit-remaining-tokens': '29897', 'x-ratelimit-reset-requests': '6m30.702999999s', 'x-ratelimit-reset-tokens': '206ms', 'x-request-id': 'req_01jyebvxpef0rvv8nfkfkze4vs', 'cf-cache-status': 'DYNAMIC', 'set-cookie': '__cf_bm=WpPlTBs80gujOfjh6.oDplVqE3t4i3oBZ0T5KTLrmF4-1750681384-1.0.1.1-mlhE9FuNfaQ7RiQ6aVG8mzhanMfqlzoOUgkrif2IkQgUxldxs3pxZ760ybXx4ur_MfFA23ffuHo93nA2MRnVp8CiI9m4i_j1zDE2Iyc5suA; path=/; expires=Mon, 23-Jun-25 12:53:04 GMT; domain=.groq.com; HttpOnly; Secure; SameSite=None', 'server': 'cloudflare', 'cf-ray': '9543f45dbe226665-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-23 14:23:04,890 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='073at3nmn', function=Function(arguments='{"dni":"12345678A"}', name='datos_abonado'), type='function')])
2025-06-23 14:23:04,890 - INFO - Executing tool: datos_abonado with args: {'dni': '12345678A'}
2025-06-23 14:23:05,493 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:23:07,547 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001A838B535C0>
2025-06-23 14:23:07,547 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:23:07,547 - DEBUG - send_request_headers.complete
2025-06-23 14:23:07,548 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:23:07,548 - DEBUG - send_request_body.complete
2025-06-23 14:23:07,548 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:23:07,555 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:23:06 GMT'), (b'server', b'uvicorn'), (b'content-length', b'141'), (b'content-type', b'application/json')])
2025-06-23 14:23:07,556 - INFO - HTTP Request: POST http://localhost:8000/datos_abonado "HTTP/1.1 200 OK"
2025-06-23 14:23:07,556 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:23:07,556 - DEBUG - receive_response_body.complete
2025-06-23 14:23:07,556 - DEBUG - response_closed.started
2025-06-23 14:23:07,556 - DEBUG - response_closed.complete
2025-06-23 14:23:07,557 - DEBUG - close.started
2025-06-23 14:23:07,557 - DEBUG - close.complete
2025-06-23 14:23:07,557 - INFO - Raw tool response for datos_abonado: {'nombre': 'Juan Pérez', 'dni': '12345678A', 'direccion': 'Calle Falsa 123', 'correo': 'juan@example.com', 'telefono': '123456789', 'poliza': 'POL123'}
2025-06-23 14:23:07,557 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-23 14:23:07,557 - INFO - Final Markdown content: ### Datos del abonado
- **Nombre:** Juan Pérez
- **DNI:** 12345678A
- **Dirección:** Calle Falsa 123
- **Correo electrónico:** juan@example.com
- **Teléfono:** 123456789
- **Póliza:** POL123
2025-06-23 14:23:09,637 - DEBUG - Initial context before applying field rules: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada para el usuario 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'incidencia_creacion', 'dni': '12345678A', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada para el usuario 12345678A'}
2025-06-23 14:23:09,637 - DEBUG - Applying field rules: {'inherit': [], 'remove': ['dni']}
2025-06-23 14:23:09,637 - DEBUG - Skipping removal of field: dni
2025-06-23 14:23:09,637 - DEBUG - Context after applying removal rules: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada para el usuario 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'incidencia_creacion', 'dni': '12345678A', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada para el usuario 12345678A'}
2025-06-23 14:23:09,637 - DEBUG - Context after applying inheritance rules: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada para el usuario 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'incidencia_creacion', 'dni': '12345678A', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada para el usuario 12345678A'}
2025-06-23 14:23:09,637 - DEBUG - Context after update: {'last_message': 'crea una incidencia en Huelva, furgoneta averiada para el usuario 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'incidencia_creacion', 'dni': '12345678A', 'ubicacion': 'Huelva', 'descripcion': 'furgoneta averiada para el usuario 12345678A'}
2025-06-23 14:23:09,637 - INFO - User message: crea una incidencia en Huelva, furgoneta averiada para el usuario 12345678A
2025-06-23 14:23:09,637 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-23 14:23:09,639 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-0969acb3-28de-4fd2-b9f2-46fb1cf0fd8a', 'json_data': {'messages': [{'role': 'system', 'content': "Eres un agente especializado en gestión de incidencias. **No inventes datos**; extrae el DNI o ID de incidencia y llama a la herramienta correcta. Presenta sólo los datos reales obtenidos de la API. No llames a herramientas de abonado como direccion_abonado para consultas de incidencias. \n\nCuando te pregunten por una ubicación, usa siempre incidencias_por_ubicacion. Si la pregunta es referencial (ejemplo: 'Y en Barcelona?'), significa que el usuario quiere consultar las incidencias en esa nueva ubicación. Asegúrate de que las consultas referenciales con ubicación generen siempre una llamada a la herramienta adecuada."}, {'role': 'user', 'content': 'crea una incidencia en Huelva, furgoneta averiada para el usuario 12345678A'}], 'model': 'meta-llama/llama-4-scout-17b-16e-instruct', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': "Esta herramienta realiza la operación 'existe_abonado' en el endpoint '/existe_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': "Esta herramienta realiza la operación 'direccion_abonado' en el endpoint '/direccion_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': "Esta herramienta realiza la operación 'estado_pagos' en el endpoint '/estado_pagos' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': "Esta herramienta realiza la operación 'ultimo_pago' en el endpoint '/ultimo_pago' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': "Esta herramienta realiza la operación 'deuda_total' en el endpoint '/deuda_total' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': "Esta herramienta realiza la operación 'facturas_pendientes' en el endpoint '/facturas_pendientes' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': "Esta herramienta realiza la operación 'todas_las_facturas' en el endpoint '/todas_las_facturas' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': "Esta herramienta realiza la operación 'datos_abonado' en el endpoint '/datos_abonado' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': "Esta herramienta realiza la operación 'crear_incidencia' en el endpoint '/crear_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': "Esta herramienta realiza la operación 'incidencias_por_dni' en el endpoint '/incidencias_por_dni' usando el método 'POST.'", 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': "Esta herramienta realiza la operación 'incidencias_por_nombre' en el endpoint '/incidencias_por_nombre' usando el método 'POST.'", 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': "Esta herramienta realiza la operación 'actualizar_estado_incidencia' en el endpoint '/actualizar_estado_incidencia' usando el método 'POST.'", 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': "Esta herramienta realiza la operación 'incidencias_pendientes' en el endpoint '/incidencias_pendientes' usando el método 'POST.'", 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': "Esta herramienta realiza la operación 'incidencias_por_ubicacion' en el endpoint '/incidencias_por_ubicacion' usando el método 'POST.'", 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': "Esta herramienta realiza la operación 'herramientas_disponibles' en el endpoint '/herramientas_disponibles' usando el método 'GET.'", 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-23 14:23:09,640 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-23 14:23:09,641 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:23:09,641 - DEBUG - send_request_headers.complete
2025-06-23 14:23:09,642 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:23:09,642 - DEBUG - send_request_body.complete
2025-06-23 14:23:09,642 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:23:09,995 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Mon, 23 Jun 2025 12:23:10 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'1000'), (b'x-ratelimit-limit-tokens', b'30000'), (b'x-ratelimit-remaining-requests', b'994'), (b'x-ratelimit-remaining-tokens', b'29815'), (b'x-ratelimit-reset-requests', b'8m33.248s'), (b'x-ratelimit-reset-tokens', b'370ms'), (b'x-request-id', b'req_01jyebw2qeeyar7ps5nffdq40t'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9543f47e18886665-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-23 14:23:09,995 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-23 14:23:09,996 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:23:09,996 - DEBUG - receive_response_body.complete
2025-06-23 14:23:09,996 - DEBUG - response_closed.started
2025-06-23 14:23:09,996 - DEBUG - response_closed.complete
2025-06-23 14:23:09,996 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Mon, 23 Jun 2025 12:23:10 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '1000', 'x-ratelimit-limit-tokens': '30000', 'x-ratelimit-remaining-requests': '994', 'x-ratelimit-remaining-tokens': '29815', 'x-ratelimit-reset-requests': '8m33.248s', 'x-ratelimit-reset-tokens': '370ms', 'x-request-id': 'req_01jyebw2qeeyar7ps5nffdq40t', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '9543f47e18886665-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-23 14:23:09,997 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='jhvpj8ert', function=Function(arguments='{"descripcion":"Furgoneta averiada","dni":"12345678A","ubicacion":"Huelva"}', name='crear_incidencia'), type='function')])
2025-06-23 14:23:09,998 - INFO - Executing tool: crear_incidencia with args: {'descripcion': 'Furgoneta averiada', 'dni': '12345678A', 'ubicacion': 'Huelva'}
2025-06-23 14:23:10,545 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:23:12,566 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001A838CEA060>
2025-06-23 14:23:12,567 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-23 14:23:12,568 - DEBUG - send_request_headers.complete
2025-06-23 14:23:12,568 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-23 14:23:12,568 - DEBUG - send_request_body.complete
2025-06-23 14:23:12,568 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-23 14:23:12,595 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:23:11 GMT'), (b'server', b'uvicorn'), (b'content-length', b'78'), (b'content-type', b'application/json')])
2025-06-23 14:23:12,596 - INFO - HTTP Request: POST http://localhost:8000/crear_incidencia "HTTP/1.1 200 OK"
2025-06-23 14:23:12,596 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-23 14:23:12,597 - DEBUG - receive_response_body.complete
2025-06-23 14:23:12,597 - DEBUG - response_closed.started
2025-06-23 14:23:12,597 - DEBUG - response_closed.complete
2025-06-23 14:23:12,597 - DEBUG - close.started
2025-06-23 14:23:12,597 - DEBUG - close.complete
2025-06-23 14:23:12,598 - INFO - Raw tool response for crear_incidencia: {'message': 'Incidencia creada exitosamente para el abonado con DNI 12345678A'}
2025-06-23 14:23:12,598 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-23 14:23:12,598 - INFO - Final Markdown content: ### Resultado de la creación de incidencia
- **Mensaje:** Incidencia creada exitosamente para el abonado con DNI 12345678A
2025-06-23 14:28:26,639 - DEBUG - close.started
2025-06-23 14:28:26,641 - DEBUG - close.complete
2025-06-23 14:28:28,871 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:28:30,916 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001AAA5449160>
2025-06-23 14:28:30,917 - DEBUG - send_request_headers.started request=<Request [b'GET']>
2025-06-23 14:28:30,917 - DEBUG - send_request_headers.complete
2025-06-23 14:28:30,917 - DEBUG - send_request_body.started request=<Request [b'GET']>
2025-06-23 14:28:30,917 - DEBUG - send_request_body.complete
2025-06-23 14:28:30,917 - DEBUG - receive_response_headers.started request=<Request [b'GET']>
2025-06-23 14:28:30,933 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:28:30 GMT'), (b'server', b'uvicorn'), (b'content-length', b'9382'), (b'content-type', b'application/json')])
2025-06-23 14:28:30,933 - INFO - HTTP Request: GET http://localhost:8000/openapi.json "HTTP/1.1 200 OK"
2025-06-23 14:28:30,933 - DEBUG - receive_response_body.started request=<Request [b'GET']>
2025-06-23 14:28:30,934 - DEBUG - receive_response_body.complete
2025-06-23 14:28:30,934 - DEBUG - response_closed.started
2025-06-23 14:28:30,934 - DEBUG - response_closed.complete
2025-06-23 14:28:30,934 - DEBUG - close.started
2025-06-23 14:28:30,934 - DEBUG - close.complete
2025-06-23 14:28:50,492 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:28:52,527 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000021871429160>
2025-06-23 14:28:52,527 - DEBUG - send_request_headers.started request=<Request [b'GET']>
2025-06-23 14:28:52,528 - DEBUG - send_request_headers.complete
2025-06-23 14:28:52,528 - DEBUG - send_request_body.started request=<Request [b'GET']>
2025-06-23 14:28:52,529 - DEBUG - send_request_body.complete
2025-06-23 14:28:52,529 - DEBUG - receive_response_headers.started request=<Request [b'GET']>
2025-06-23 14:28:52,544 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:28:51 GMT'), (b'server', b'uvicorn'), (b'content-length', b'9382'), (b'content-type', b'application/json')])
2025-06-23 14:28:52,545 - INFO - HTTP Request: GET http://localhost:8000/openapi.json "HTTP/1.1 200 OK"
2025-06-23 14:28:52,545 - DEBUG - receive_response_body.started request=<Request [b'GET']>
2025-06-23 14:28:52,546 - DEBUG - receive_response_body.complete
2025-06-23 14:28:52,546 - DEBUG - response_closed.started
2025-06-23 14:28:52,546 - DEBUG - response_closed.complete
2025-06-23 14:28:52,546 - DEBUG - close.started
2025-06-23 14:28:52,546 - DEBUG - close.complete
2025-06-23 14:36:33,969 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:36:36,033 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002982CB19160>
2025-06-23 14:36:36,034 - DEBUG - send_request_headers.started request=<Request [b'GET']>
2025-06-23 14:36:36,034 - DEBUG - send_request_headers.complete
2025-06-23 14:36:36,034 - DEBUG - send_request_body.started request=<Request [b'GET']>
2025-06-23 14:36:36,034 - DEBUG - send_request_body.complete
2025-06-23 14:36:36,034 - DEBUG - receive_response_headers.started request=<Request [b'GET']>
2025-06-23 14:36:36,413 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:36:36 GMT'), (b'server', b'uvicorn'), (b'content-length', b'9382'), (b'content-type', b'application/json')])
2025-06-23 14:36:36,413 - INFO - HTTP Request: GET http://localhost:8000/openapi.json "HTTP/1.1 200 OK"
2025-06-23 14:36:36,414 - DEBUG - receive_response_body.started request=<Request [b'GET']>
2025-06-23 14:36:36,414 - DEBUG - receive_response_body.complete
2025-06-23 14:36:36,414 - DEBUG - response_closed.started
2025-06-23 14:36:36,414 - DEBUG - response_closed.complete
2025-06-23 14:36:36,414 - DEBUG - close.started
2025-06-23 14:36:36,414 - DEBUG - close.complete
2025-06-23 14:36:38,865 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-23 14:36:40,935 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000018156CB9400>
2025-06-23 14:36:40,935 - DEBUG - send_request_headers.started request=<Request [b'GET']>
2025-06-23 14:36:40,936 - DEBUG - send_request_headers.complete
2025-06-23 14:36:40,936 - DEBUG - send_request_body.started request=<Request [b'GET']>
2025-06-23 14:36:40,936 - DEBUG - send_request_body.complete
2025-06-23 14:36:40,936 - DEBUG - receive_response_headers.started request=<Request [b'GET']>
2025-06-23 14:36:40,939 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Mon, 23 Jun 2025 12:36:40 GMT'), (b'server', b'uvicorn'), (b'content-length', b'9382'), (b'content-type', b'application/json')])
2025-06-23 14:36:40,939 - INFO - HTTP Request: GET http://localhost:8000/openapi.json "HTTP/1.1 200 OK"
2025-06-23 14:36:40,939 - DEBUG - receive_response_body.started request=<Request [b'GET']>
2025-06-23 14:36:40,939 - DEBUG - receive_response_body.complete
2025-06-23 14:36:40,939 - DEBUG - response_closed.started
2025-06-23 14:36:40,939 - DEBUG - response_closed.complete
2025-06-23 14:36:40,939 - DEBUG - close.started
2025-06-23 14:36:40,940 - DEBUG - close.complete

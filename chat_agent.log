2025-06-20 12:50:05,636 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:50:07,708 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D1E1160>
2025-06-20 12:50:07,708 - DEBUG - send_request_headers.started request=<Request [b'GET']>
2025-06-20 12:50:07,709 - DEBUG - send_request_headers.complete
2025-06-20 12:50:07,709 - DEBUG - send_request_body.started request=<Request [b'GET']>
2025-06-20 12:50:07,709 - DEBUG - send_request_body.complete
2025-06-20 12:50:07,709 - DEBUG - receive_response_headers.started request=<Request [b'GET']>
2025-06-20 12:50:07,710 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Fri, 20 Jun 2025 10:50:06 GMT'), (b'server', b'uvicorn'), (b'content-length', b'9382'), (b'content-type', b'application/json')])
2025-06-20 12:50:07,711 - INFO - HTTP Request: GET http://localhost:8000/openapi.json "HTTP/1.1 200 OK"
2025-06-20 12:50:07,711 - DEBUG - receive_response_body.started request=<Request [b'GET']>
2025-06-20 12:50:07,711 - DEBUG - receive_response_body.complete
2025-06-20 12:50:07,711 - DEBUG - response_closed.started
2025-06-20 12:50:07,711 - DEBUG - response_closed.complete
2025-06-20 12:50:07,711 - DEBUG - close.started
2025-06-20 12:50:07,711 - DEBUG - close.complete
2025-06-20 12:50:14,436 - DEBUG - Context after update: {'last_message': 'Incidencias en madrid', 'requires_real_data': True, 'is_referential': False, 'query_type': 'incidencia_consulta', 'ubicacion': 'madrid'}
2025-06-20 12:50:14,436 - INFO - User message: Incidencias en madrid
2025-06-20 12:50:14,436 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-20 12:50:14,485 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-4795eeec-8af9-4671-9e8b-37035d545bd8', 'json_data': {'messages': [{'role': 'system', 'content': "Eres un agente especializado en gesti�n de incidencias. **No inventes datos**; extrae el DNI o ID de incidencia y llama a la herramienta correcta. Presenta s�lo los datos reales obtenidos de la API. No llames a herramientas de abonado como direccion_abonado para consultas de incidencias. \n\nCuando te pregunten por una ubicaci�n, usa siempre incidencias_por_ubicacion. Si la pregunta es referencial (ejemplo: 'Y en Barcelona?'), significa que el usuario quiere consultar las incidencias en esa nueva ubicaci�n. Aseg�rate de que las consultas referenciales con ubicaci�n generen siempre una llamada a la herramienta adecuada."}, {'role': 'user', 'content': 'Incidencias en madrid'}], 'model': 'llama-3.1-8b-instant', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': 'Herramienta para existe_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': 'Herramienta para direccion_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': 'Herramienta para estado_pagos', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': 'Herramienta para ultimo_pago', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': 'Herramienta para deuda_total', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': 'Herramienta para facturas_pendientes', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': 'Herramienta para todas_las_facturas', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': 'Herramienta para datos_abonado', 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': 'Herramienta para crear_incidencia', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': 'Herramienta para incidencias_por_dni', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': 'Herramienta para incidencias_por_nombre', 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': 'Herramienta para actualizar_estado_incidencia', 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': 'Herramienta para incidencias_pendientes', 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': 'Herramienta para incidencias_por_ubicacion', 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': 'Herramienta para herramientas_disponibles', 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-20 12:50:14,584 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-20 12:50:14,584 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:50:14,658 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D2911D0>
2025-06-20 12:50:14,658 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002309D199A30> server_hostname='api.groq.com' timeout=5.0
2025-06-20 12:50:14,691 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D291310>
2025-06-20 12:50:14,692 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:50:14,692 - DEBUG - send_request_headers.complete
2025-06-20 12:50:14,692 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:50:14,692 - DEBUG - send_request_body.complete
2025-06-20 12:50:14,692 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:50:15,048 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Fri, 20 Jun 2025 10:50:15 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'14400'), (b'x-ratelimit-limit-tokens', b'6000'), (b'x-ratelimit-remaining-requests', b'14399'), (b'x-ratelimit-remaining-tokens', b'5828'), (b'x-ratelimit-reset-requests', b'6s'), (b'x-ratelimit-reset-tokens', b'1.72s'), (b'x-request-id', b'req_01jy6fbsd0fm08nfsqsk94pp9n'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=1OMN0DlZx0yJ7In4r6fpOhmruI8xKS042s7IqQm4NdU-1750416615-1.0.1.1-ujEvboHWlQbwVy2uJ8DO11cyithphu9p8hlA3LRyGUXFb0j.XqDiDeCc3wgKbBkxP6XFiNBstklecuJ68iv1ANuj26x0OdjPb9.0Eq1yn18; path=/; expires=Fri, 20-Jun-25 11:20:15 GMT; domain=.groq.com; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'952ab4420dbfcfaa-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-20 12:50:15,048 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-20 12:50:15,049 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:50:15,049 - DEBUG - receive_response_body.complete
2025-06-20 12:50:15,049 - DEBUG - response_closed.started
2025-06-20 12:50:15,049 - DEBUG - response_closed.complete
2025-06-20 12:50:15,049 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Fri, 20 Jun 2025 10:50:15 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '14400', 'x-ratelimit-limit-tokens': '6000', 'x-ratelimit-remaining-requests': '14399', 'x-ratelimit-remaining-tokens': '5828', 'x-ratelimit-reset-requests': '6s', 'x-ratelimit-reset-tokens': '1.72s', 'x-request-id': 'req_01jy6fbsd0fm08nfsqsk94pp9n', 'cf-cache-status': 'DYNAMIC', 'set-cookie': '__cf_bm=1OMN0DlZx0yJ7In4r6fpOhmruI8xKS042s7IqQm4NdU-1750416615-1.0.1.1-ujEvboHWlQbwVy2uJ8DO11cyithphu9p8hlA3LRyGUXFb0j.XqDiDeCc3wgKbBkxP6XFiNBstklecuJ68iv1ANuj26x0OdjPb9.0Eq1yn18; path=/; expires=Fri, 20-Jun-25 11:20:15 GMT; domain=.groq.com; HttpOnly; Secure; SameSite=None', 'server': 'cloudflare', 'cf-ray': '952ab4420dbfcfaa-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-20 12:50:15,050 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='j7a1wgsxc', function=Function(arguments='{"ubicacion":"madrid"}', name='incidencias_por_ubicacion'), type='function')])
2025-06-20 12:50:15,050 - INFO - Executing tool: incidencias_por_ubicacion with args: {'ubicacion': 'madrid'}
2025-06-20 12:50:15,522 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:50:17,559 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D123820>
2025-06-20 12:50:17,559 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:50:17,560 - DEBUG - send_request_headers.complete
2025-06-20 12:50:17,560 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:50:17,560 - DEBUG - send_request_body.complete
2025-06-20 12:50:17,560 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:50:17,563 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Fri, 20 Jun 2025 10:50:16 GMT'), (b'server', b'uvicorn'), (b'content-length', b'109'), (b'content-type', b'application/json')])
2025-06-20 12:50:17,563 - INFO - HTTP Request: POST http://localhost:8000/incidencias_por_ubicacion "HTTP/1.1 200 OK"
2025-06-20 12:50:17,564 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:50:17,564 - DEBUG - receive_response_body.complete
2025-06-20 12:50:17,564 - DEBUG - response_closed.started
2025-06-20 12:50:17,564 - DEBUG - response_closed.complete
2025-06-20 12:50:17,564 - DEBUG - close.started
2025-06-20 12:50:17,564 - DEBUG - close.complete
2025-06-20 12:50:17,564 - INFO - Raw tool response for incidencias_por_ubicacion: {'incidencias': [{'ubicacion': 'Madrid', 'descripcion': 'Fallo en el suministro el�ctrico', 'estado': 'Abierto'}]}
2025-06-20 12:50:17,564 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-20 12:50:17,564 - INFO - Final Markdown content: ### Incidencias
**Resumen:**
- Total: 1 incidencia(s)
- Abiertas: 1
- En proceso: 0
- Resueltas: 0

#### Detalles
| Ubicaci�n | Descripci�n | Estado |
|:----------|:------------|:-------|
| Madrid | Fallo en el suministro el�ctrico | Abierto |
2025-06-20 12:50:21,584 - DEBUG - Context after update: {'last_message': 'Y en barcelona', 'requires_real_data': False, 'is_referential': True, 'query_type': 'incidencia_consulta', 'ubicacion': 'barcelona'}
2025-06-20 12:50:21,584 - INFO - User message: Y en barcelona
2025-06-20 12:50:21,585 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-20 12:50:21,585 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-4e17362c-28e2-4bb5-adb7-b7e1f0c77bf4', 'json_data': {'messages': [{'role': 'system', 'content': 'Eres un asistente general. Responde preguntas comunes sin inventar datos. Si no aplican herramientas espec�ficas, responde con conocimiento general. Utiliza siempre el contexto disponible (como DNI, tipo de consulta, etc.) para responder o realizar llamadas a herramientas, especialmente en consultas referenciales.'}, {'role': 'user', 'content': 'Y en barcelona'}], 'model': 'llama-3.1-8b-instant', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': 'Herramienta para existe_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': 'Herramienta para direccion_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': 'Herramienta para estado_pagos', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': 'Herramienta para ultimo_pago', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': 'Herramienta para deuda_total', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': 'Herramienta para facturas_pendientes', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': 'Herramienta para todas_las_facturas', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': 'Herramienta para datos_abonado', 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': 'Herramienta para crear_incidencia', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': 'Herramienta para incidencias_por_dni', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': 'Herramienta para incidencias_por_nombre', 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': 'Herramienta para actualizar_estado_incidencia', 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': 'Herramienta para incidencias_pendientes', 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': 'Herramienta para incidencias_por_ubicacion', 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': 'Herramienta para herramientas_disponibles', 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-20 12:50:21,586 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-20 12:50:21,586 - DEBUG - close.started
2025-06-20 12:50:21,586 - DEBUG - close.complete
2025-06-20 12:50:21,586 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:50:21,614 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D2B4FC0>
2025-06-20 12:50:21,614 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002309D199A30> server_hostname='api.groq.com' timeout=5.0
2025-06-20 12:50:21,646 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D1DB1D0>
2025-06-20 12:50:21,647 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:50:21,647 - DEBUG - send_request_headers.complete
2025-06-20 12:50:21,647 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:50:21,647 - DEBUG - send_request_body.complete
2025-06-20 12:50:21,647 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:50:21,927 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Fri, 20 Jun 2025 10:50:21 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'14400'), (b'x-ratelimit-limit-tokens', b'6000'), (b'x-ratelimit-remaining-requests', b'14399'), (b'x-ratelimit-remaining-tokens', b'5041'), (b'x-ratelimit-reset-requests', b'6s'), (b'x-ratelimit-reset-tokens', b'9.586999999s'), (b'x-request-id', b'req_01jy6fc04qex18nf1gr7y4aqq7'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'952ab46d8de3ec9a-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-20 12:50:21,927 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-20 12:50:21,927 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:50:21,928 - DEBUG - receive_response_body.complete
2025-06-20 12:50:21,928 - DEBUG - response_closed.started
2025-06-20 12:50:21,928 - DEBUG - response_closed.complete
2025-06-20 12:50:21,928 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Fri, 20 Jun 2025 10:50:21 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '14400', 'x-ratelimit-limit-tokens': '6000', 'x-ratelimit-remaining-requests': '14399', 'x-ratelimit-remaining-tokens': '5041', 'x-ratelimit-reset-requests': '6s', 'x-ratelimit-reset-tokens': '9.586999999s', 'x-request-id': 'req_01jy6fc04qex18nf1gr7y4aqq7', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '952ab46d8de3ec9a-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-20 12:50:21,929 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='jmw1tejjt', function=Function(arguments='null', name='herramientas_disponibles'), type='function')])
2025-06-20 12:50:21,929 - ERROR - Arguments for function herramientas_disponibles are None. Skipping execution.
2025-06-20 12:50:21,929 - INFO - Final response prepared: 
2025-06-20 12:50:33,849 - DEBUG - Context after update: {'last_message': 'y en barcelona', 'requires_real_data': False, 'is_referential': True, 'query_type': 'incidencia_consulta', 'ubicacion': 'barcelona'}
2025-06-20 12:50:33,849 - INFO - User message: y en barcelona
2025-06-20 12:50:33,849 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-20 12:50:33,851 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-e26cdbf1-0bba-40fc-a053-e55eac2f3f90', 'json_data': {'messages': [{'role': 'system', 'content': "Eres un agente especializado en gesti�n de incidencias. **No inventes datos**; extrae el DNI o ID de incidencia y llama a la herramienta correcta. Presenta s�lo los datos reales obtenidos de la API. No llames a herramientas de abonado como direccion_abonado para consultas de incidencias. \n\nCuando te pregunten por una ubicaci�n, usa siempre incidencias_por_ubicacion. Si la pregunta es referencial (ejemplo: 'Y en Barcelona?'), significa que el usuario quiere consultar las incidencias en esa nueva ubicaci�n. Aseg�rate de que las consultas referenciales con ubicaci�n generen siempre una llamada a la herramienta adecuada."}, {'role': 'user', 'content': 'y en barcelona'}], 'model': 'llama-3.1-8b-instant', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': 'Herramienta para existe_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': 'Herramienta para direccion_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': 'Herramienta para estado_pagos', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': 'Herramienta para ultimo_pago', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': 'Herramienta para deuda_total', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': 'Herramienta para facturas_pendientes', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': 'Herramienta para todas_las_facturas', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': 'Herramienta para datos_abonado', 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': 'Herramienta para crear_incidencia', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': 'Herramienta para incidencias_por_dni', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': 'Herramienta para incidencias_por_nombre', 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': 'Herramienta para actualizar_estado_incidencia', 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': 'Herramienta para incidencias_pendientes', 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': 'Herramienta para incidencias_por_ubicacion', 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': 'Herramienta para herramientas_disponibles', 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-20 12:50:33,852 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-20 12:50:33,852 - DEBUG - close.started
2025-06-20 12:50:33,852 - DEBUG - close.complete
2025-06-20 12:50:33,852 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:50:33,933 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D2B8D10>
2025-06-20 12:50:33,933 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002309D199A30> server_hostname='api.groq.com' timeout=5.0
2025-06-20 12:50:33,964 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D2B89E0>
2025-06-20 12:50:33,965 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:50:33,965 - DEBUG - send_request_headers.complete
2025-06-20 12:50:33,965 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:50:33,965 - DEBUG - send_request_body.complete
2025-06-20 12:50:33,965 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:50:34,308 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Fri, 20 Jun 2025 10:50:34 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'14400'), (b'x-ratelimit-limit-tokens', b'6000'), (b'x-ratelimit-remaining-requests', b'14399'), (b'x-ratelimit-remaining-tokens', b'4760'), (b'x-ratelimit-reset-requests', b'6s'), (b'x-ratelimit-reset-tokens', b'12.398s'), (b'x-request-id', b'req_01jy6fcc73exhaqj0s314njzxq'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'952ab4ba8b88f775-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-20 12:50:34,308 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-20 12:50:34,308 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:50:34,309 - DEBUG - receive_response_body.complete
2025-06-20 12:50:34,309 - DEBUG - response_closed.started
2025-06-20 12:50:34,309 - DEBUG - response_closed.complete
2025-06-20 12:50:34,309 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Fri, 20 Jun 2025 10:50:34 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '14400', 'x-ratelimit-limit-tokens': '6000', 'x-ratelimit-remaining-requests': '14399', 'x-ratelimit-remaining-tokens': '4760', 'x-ratelimit-reset-requests': '6s', 'x-ratelimit-reset-tokens': '12.398s', 'x-request-id': 'req_01jy6fcc73exhaqj0s314njzxq', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '952ab4ba8b88f775-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-20 12:50:34,309 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='a734y7p98', function=Function(arguments='{"ubicacion":"Barcelona"}', name='incidencias_por_ubicacion'), type='function')])
2025-06-20 12:50:34,310 - INFO - Executing tool: incidencias_por_ubicacion with args: {'ubicacion': 'Barcelona'}
2025-06-20 12:50:34,752 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:50:36,793 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D2C0650>
2025-06-20 12:50:36,793 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:50:36,793 - DEBUG - send_request_headers.complete
2025-06-20 12:50:36,793 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:50:36,794 - DEBUG - send_request_body.complete
2025-06-20 12:50:36,794 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:50:36,797 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Fri, 20 Jun 2025 10:50:35 GMT'), (b'server', b'uvicorn'), (b'content-length', b'185'), (b'content-type', b'application/json')])
2025-06-20 12:50:36,798 - INFO - HTTP Request: POST http://localhost:8000/incidencias_por_ubicacion "HTTP/1.1 200 OK"
2025-06-20 12:50:36,798 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:50:36,798 - DEBUG - receive_response_body.complete
2025-06-20 12:50:36,798 - DEBUG - response_closed.started
2025-06-20 12:50:36,798 - DEBUG - response_closed.complete
2025-06-20 12:50:36,798 - DEBUG - close.started
2025-06-20 12:50:36,798 - DEBUG - close.complete
2025-06-20 12:50:36,798 - INFO - Raw tool response for incidencias_por_ubicacion: {'incidencias': [{'ubicacion': 'Barcelona', 'descripcion': 'Problema con la factura', 'estado': 'Resuelto'}, {'ubicacion': 'Barcelona', 'descripcion': 'fallo en el servicio', 'estado': 'Abierto'}]}
2025-06-20 12:50:36,799 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-20 12:50:36,799 - INFO - Final Markdown content: ### Incidencias
**Resumen:**
- Total: 2 incidencia(s)
- Abiertas: 1
- En proceso: 0
- Resueltas: 1

#### Detalles
| Ubicaci�n | Descripci�n | Estado |
|:----------|:------------|:-------|
| Barcelona | fallo en el servicio | Abierto |
| Barcelona | Problema con la factura | Resuelto |
2025-06-20 12:50:50,541 - DEBUG - Context after update: {'last_message': 'y en valencia?', 'requires_real_data': False, 'is_referential': True, 'query_type': 'incidencia_consulta', 'ubicacion': 'barcelona'}
2025-06-20 12:50:50,541 - INFO - User message: y en valencia?
2025-06-20 12:50:50,541 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-20 12:50:50,542 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-f019a4bc-3228-4f46-b48a-87d756e9c00f', 'json_data': {'messages': [{'role': 'system', 'content': "Eres un agente especializado en gesti�n de incidencias. **No inventes datos**; extrae el DNI o ID de incidencia y llama a la herramienta correcta. Presenta s�lo los datos reales obtenidos de la API. No llames a herramientas de abonado como direccion_abonado para consultas de incidencias. \n\nCuando te pregunten por una ubicaci�n, usa siempre incidencias_por_ubicacion. Si la pregunta es referencial (ejemplo: 'Y en Barcelona?'), significa que el usuario quiere consultar las incidencias en esa nueva ubicaci�n. Aseg�rate de que las consultas referenciales con ubicaci�n generen siempre una llamada a la herramienta adecuada."}, {'role': 'user', 'content': 'y en valencia?'}], 'model': 'llama-3.1-8b-instant', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': 'Herramienta para existe_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': 'Herramienta para direccion_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': 'Herramienta para estado_pagos', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': 'Herramienta para ultimo_pago', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': 'Herramienta para deuda_total', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': 'Herramienta para facturas_pendientes', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': 'Herramienta para todas_las_facturas', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': 'Herramienta para datos_abonado', 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': 'Herramienta para crear_incidencia', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': 'Herramienta para incidencias_por_dni', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': 'Herramienta para incidencias_por_nombre', 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': 'Herramienta para actualizar_estado_incidencia', 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': 'Herramienta para incidencias_pendientes', 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': 'Herramienta para incidencias_por_ubicacion', 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': 'Herramienta para herramientas_disponibles', 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-20 12:50:50,543 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-20 12:50:50,544 - DEBUG - close.started
2025-06-20 12:50:50,544 - DEBUG - close.complete
2025-06-20 12:50:50,544 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:50:50,583 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D23BB50>
2025-06-20 12:50:50,583 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002309D199A30> server_hostname='api.groq.com' timeout=5.0
2025-06-20 12:50:50,615 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D2194F0>
2025-06-20 12:50:50,615 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:50:50,615 - DEBUG - send_request_headers.complete
2025-06-20 12:50:50,615 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:50:50,615 - DEBUG - send_request_body.complete
2025-06-20 12:50:50,615 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:50:50,959 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Fri, 20 Jun 2025 10:50:50 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'14400'), (b'x-ratelimit-limit-tokens', b'6000'), (b'x-ratelimit-remaining-requests', b'14399'), (b'x-ratelimit-remaining-tokens', b'4887'), (b'x-ratelimit-reset-requests', b'6s'), (b'x-ratelimit-reset-tokens', b'11.13s'), (b'x-request-id', b'req_01jy6fcwdwfngtcw7pmq4d3xs2'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'952ab5229eb9f76b-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-20 12:50:50,959 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-20 12:50:50,960 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:50:50,960 - DEBUG - receive_response_body.complete
2025-06-20 12:50:50,960 - DEBUG - response_closed.started
2025-06-20 12:50:50,960 - DEBUG - response_closed.complete
2025-06-20 12:50:50,960 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Fri, 20 Jun 2025 10:50:50 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '14400', 'x-ratelimit-limit-tokens': '6000', 'x-ratelimit-remaining-requests': '14399', 'x-ratelimit-remaining-tokens': '4887', 'x-ratelimit-reset-requests': '6s', 'x-ratelimit-reset-tokens': '11.13s', 'x-request-id': 'req_01jy6fcwdwfngtcw7pmq4d3xs2', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '952ab5229eb9f76b-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-20 12:50:50,961 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='5s92fw4jh', function=Function(arguments='{"ubicacion":"valencia"}', name='incidencias_por_ubicacion'), type='function')])
2025-06-20 12:50:50,961 - INFO - Executing tool: incidencias_por_ubicacion with args: {'ubicacion': 'valencia'}
2025-06-20 12:50:51,429 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:50:53,459 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D219A90>
2025-06-20 12:50:53,459 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:50:53,460 - DEBUG - send_request_headers.complete
2025-06-20 12:50:53,460 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:50:53,460 - DEBUG - send_request_body.complete
2025-06-20 12:50:53,460 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:50:53,463 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Fri, 20 Jun 2025 10:50:53 GMT'), (b'server', b'uvicorn'), (b'content-length', b'106'), (b'content-type', b'application/json')])
2025-06-20 12:50:53,463 - INFO - HTTP Request: POST http://localhost:8000/incidencias_por_ubicacion "HTTP/1.1 200 OK"
2025-06-20 12:50:53,463 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:50:53,463 - DEBUG - receive_response_body.complete
2025-06-20 12:50:53,463 - DEBUG - response_closed.started
2025-06-20 12:50:53,463 - DEBUG - response_closed.complete
2025-06-20 12:50:53,463 - DEBUG - close.started
2025-06-20 12:50:53,463 - DEBUG - close.complete
2025-06-20 12:50:53,463 - INFO - Raw tool response for incidencias_por_ubicacion: {'incidencias': [{'ubicacion': 'Valencia', 'descripcion': 'Consulta sobre el contrato', 'estado': 'Pendiente'}]}
2025-06-20 12:50:53,463 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-20 12:50:53,463 - INFO - Final Markdown content: ### Incidencias
**Resumen:**
- Total: 1 incidencia(s)
- Abiertas: 0
- En proceso: 0
- Resueltas: 0

#### Detalles
| Ubicaci�n | Descripci�n | Estado |
|:----------|:------------|:-------|
| Valencia | Consulta sobre el contrato | Pendiente |
2025-06-20 12:51:01,297 - DEBUG - Context after update: {'last_message': 'dame los datos del abonado 12345678A', 'requires_real_data': True, 'is_referential': False, 'query_type': 'abonado', 'dni': '12345678A'}
2025-06-20 12:51:01,298 - INFO - User message: dame los datos del abonado 12345678A
2025-06-20 12:51:01,298 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-20 12:51:01,298 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-4fb77b15-6b0c-4a12-b147-f07bf36daf8b', 'json_data': {'messages': [{'role': 'system', 'content': 'Eres un asistente general. Responde preguntas comunes sin inventar datos. Si no aplican herramientas espec�ficas, responde con conocimiento general. Utiliza siempre el contexto disponible (como DNI, tipo de consulta, etc.) para responder o realizar llamadas a herramientas, especialmente en consultas referenciales.'}, {'role': 'user', 'content': 'dame los datos del abonado 12345678A'}], 'model': 'llama-3.1-8b-instant', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': 'Herramienta para existe_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': 'Herramienta para direccion_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': 'Herramienta para estado_pagos', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': 'Herramienta para ultimo_pago', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': 'Herramienta para deuda_total', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': 'Herramienta para facturas_pendientes', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': 'Herramienta para todas_las_facturas', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': 'Herramienta para datos_abonado', 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': 'Herramienta para crear_incidencia', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': 'Herramienta para incidencias_por_dni', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': 'Herramienta para incidencias_por_nombre', 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': 'Herramienta para actualizar_estado_incidencia', 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': 'Herramienta para incidencias_pendientes', 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': 'Herramienta para incidencias_por_ubicacion', 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': 'Herramienta para herramientas_disponibles', 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-20 12:51:01,299 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-20 12:51:01,299 - DEBUG - close.started
2025-06-20 12:51:01,299 - DEBUG - close.complete
2025-06-20 12:51:01,299 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:51:01,326 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D2C4830>
2025-06-20 12:51:01,327 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002309D199A30> server_hostname='api.groq.com' timeout=5.0
2025-06-20 12:51:01,357 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D2C4AD0>
2025-06-20 12:51:01,357 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:51:01,357 - DEBUG - send_request_headers.complete
2025-06-20 12:51:01,357 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:51:01,358 - DEBUG - send_request_body.complete
2025-06-20 12:51:01,358 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:51:01,658 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Fri, 20 Jun 2025 10:51:01 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'14400'), (b'x-ratelimit-limit-tokens', b'6000'), (b'x-ratelimit-remaining-requests', b'14399'), (b'x-ratelimit-remaining-tokens', b'4497'), (b'x-ratelimit-reset-requests', b'6s'), (b'x-ratelimit-reset-tokens', b'15.021999999s'), (b'x-request-id', b'req_01jy6fd6xkeycv8wrq3pk32ryz'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'952ab565ba28f769-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-20 12:51:01,659 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-20 12:51:01,659 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:51:01,659 - DEBUG - receive_response_body.complete
2025-06-20 12:51:01,659 - DEBUG - response_closed.started
2025-06-20 12:51:01,659 - DEBUG - response_closed.complete
2025-06-20 12:51:01,659 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Fri, 20 Jun 2025 10:51:01 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '14400', 'x-ratelimit-limit-tokens': '6000', 'x-ratelimit-remaining-requests': '14399', 'x-ratelimit-remaining-tokens': '4497', 'x-ratelimit-reset-requests': '6s', 'x-ratelimit-reset-tokens': '15.021999999s', 'x-request-id': 'req_01jy6fd6xkeycv8wrq3pk32ryz', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '952ab565ba28f769-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-20 12:51:01,660 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='hx75qg1n9', function=Function(arguments='{"dni":"12345678A","poliza":null}', name='datos_abonado'), type='function')])
2025-06-20 12:51:01,660 - INFO - Executing tool: datos_abonado with args: {'dni': '12345678A', 'poliza': None}
2025-06-20 12:51:02,101 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:51:04,126 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D27D7E0>
2025-06-20 12:51:04,127 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:51:04,127 - DEBUG - send_request_headers.complete
2025-06-20 12:51:04,127 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:51:04,127 - DEBUG - send_request_body.complete
2025-06-20 12:51:04,127 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:51:04,131 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Fri, 20 Jun 2025 10:51:04 GMT'), (b'server', b'uvicorn'), (b'content-length', b'141'), (b'content-type', b'application/json')])
2025-06-20 12:51:04,132 - INFO - HTTP Request: POST http://localhost:8000/datos_abonado "HTTP/1.1 200 OK"
2025-06-20 12:51:04,132 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:51:04,132 - DEBUG - receive_response_body.complete
2025-06-20 12:51:04,132 - DEBUG - response_closed.started
2025-06-20 12:51:04,132 - DEBUG - response_closed.complete
2025-06-20 12:51:04,132 - DEBUG - close.started
2025-06-20 12:51:04,132 - DEBUG - close.complete
2025-06-20 12:51:04,132 - INFO - Raw tool response for datos_abonado: {'nombre': 'Juan P�rez', 'dni': '12345678A', 'direccion': 'Calle Falsa 123', 'correo': 'juan@example.com', 'telefono': '123456789', 'poliza': 'POL123'}
2025-06-20 12:51:04,132 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-20 12:51:04,132 - INFO - Final Markdown content: ### Datos del abonado
- **Nombre:** Juan P�rez
- **DNI:** 12345678A
- **Direcci�n:** Calle Falsa 123
- **Correo electr�nico:** juan@example.com
- **Tel�fono:** 123456789
- **P�liza:** POL123
2025-06-20 12:51:08,292 - DEBUG - Context after update: {'last_message': 'todas sus facturas', 'requires_real_data': True, 'is_referential': True, 'query_type': 'factura', 'dni': '12345678A'}
2025-06-20 12:51:08,292 - DEBUG - Referential prompt injected: Reference context: The previous DNI used in this conversation is 12345678A.
2025-06-20 12:51:08,292 - INFO - User message: todas sus facturas
2025-06-20 12:51:08,292 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-20 12:51:08,293 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-69f81cc2-0d7a-4481-bb2f-1d80a8e92e01', 'json_data': {'messages': [{'role': 'system', 'content': 'Eres un agente especializado en gesti�n de facturas. **No inventes datos**; utiliza herramientas para obtener informaci�n precisa. Si el usuario proporciona un DNI o ID de factura, llama a la herramienta correspondiente. Responde �nicamente con los datos devueltos por la API en un formato claro y estructurado. Si no puedes encontrar datos, informa al usuario de manera transparente.'}, {'role': 'system', 'content': 'Reference context: The previous DNI used in this conversation is 12345678A.'}, {'role': 'user', 'content': 'todas sus facturas'}], 'model': 'llama-3.1-8b-instant', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': 'Herramienta para existe_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': 'Herramienta para direccion_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': 'Herramienta para estado_pagos', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': 'Herramienta para ultimo_pago', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': 'Herramienta para deuda_total', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': 'Herramienta para facturas_pendientes', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': 'Herramienta para todas_las_facturas', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': 'Herramienta para datos_abonado', 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': 'Herramienta para crear_incidencia', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': 'Herramienta para incidencias_por_dni', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': 'Herramienta para incidencias_por_nombre', 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': 'Herramienta para actualizar_estado_incidencia', 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': 'Herramienta para incidencias_pendientes', 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': 'Herramienta para incidencias_por_ubicacion', 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': 'Herramienta para herramientas_disponibles', 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-20 12:51:08,294 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-20 12:51:08,294 - DEBUG - close.started
2025-06-20 12:51:08,295 - DEBUG - close.complete
2025-06-20 12:51:08,295 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:51:08,328 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D2D8110>
2025-06-20 12:51:08,328 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002309D199A30> server_hostname='api.groq.com' timeout=5.0
2025-06-20 12:51:08,361 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D2D8350>
2025-06-20 12:51:08,362 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:51:08,362 - DEBUG - send_request_headers.complete
2025-06-20 12:51:08,362 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:51:08,362 - DEBUG - send_request_body.complete
2025-06-20 12:51:08,362 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:51:08,673 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Fri, 20 Jun 2025 10:51:08 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'14400'), (b'x-ratelimit-limit-tokens', b'6000'), (b'x-ratelimit-remaining-requests', b'14399'), (b'x-ratelimit-remaining-tokens', b'3703'), (b'x-ratelimit-reset-requests', b'6s'), (b'x-ratelimit-reset-tokens', b'22.969s'), (b'x-request-id', b'req_01jy6fddrseystsxdrt9nv5w34'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'952ab5917e54cc4d-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-20 12:51:08,673 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-20 12:51:08,673 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:51:08,673 - DEBUG - receive_response_body.complete
2025-06-20 12:51:08,674 - DEBUG - response_closed.started
2025-06-20 12:51:08,674 - DEBUG - response_closed.complete
2025-06-20 12:51:08,674 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Fri, 20 Jun 2025 10:51:08 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '14400', 'x-ratelimit-limit-tokens': '6000', 'x-ratelimit-remaining-requests': '14399', 'x-ratelimit-remaining-tokens': '3703', 'x-ratelimit-reset-requests': '6s', 'x-ratelimit-reset-tokens': '22.969s', 'x-request-id': 'req_01jy6fddrseystsxdrt9nv5w34', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '952ab5917e54cc4d-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-20 12:51:08,674 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='yg5qrfkv2', function=Function(arguments='{"dni":"12345678A"}', name='todas_las_facturas'), type='function')])
2025-06-20 12:51:08,674 - INFO - Executing tool: todas_las_facturas with args: {'dni': '12345678A'}
2025-06-20 12:51:09,181 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:51:11,227 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D1860A0>
2025-06-20 12:51:11,228 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:51:11,228 - DEBUG - send_request_headers.complete
2025-06-20 12:51:11,228 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:51:11,229 - DEBUG - send_request_body.complete
2025-06-20 12:51:11,229 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:51:11,232 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Fri, 20 Jun 2025 10:51:10 GMT'), (b'server', b'uvicorn'), (b'content-length', b'132'), (b'content-type', b'application/json')])
2025-06-20 12:51:11,232 - INFO - HTTP Request: POST http://localhost:8000/todas_las_facturas "HTTP/1.1 200 OK"
2025-06-20 12:51:11,232 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:51:11,232 - DEBUG - receive_response_body.complete
2025-06-20 12:51:11,232 - DEBUG - response_closed.started
2025-06-20 12:51:11,232 - DEBUG - response_closed.complete
2025-06-20 12:51:11,232 - DEBUG - close.started
2025-06-20 12:51:11,232 - DEBUG - close.complete
2025-06-20 12:51:11,232 - INFO - Raw tool response for todas_las_facturas: {'facturas': [{'fecha': '2025-06-10', 'estado': 'Pendiente', 'importe': 200.75}, {'fecha': '2025-06-01', 'estado': 'Pagado', 'importe': 100.5}]}
2025-06-20 12:51:11,233 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-20 12:51:11,233 - INFO - Final Markdown content: ### Facturas
| Fecha | Estado | Importe |
|:------|:--------|--------:|
| 2025-06-10 | Pendiente | 200.75 � |
| 2025-06-01 | Pagado | 100.50 � |

**Total pendiente:** 200.75 �
2025-06-20 12:51:16,303 - DEBUG - Context after update: {'last_message': 'Incidencias en madrid', 'requires_real_data': True, 'is_referential': False, 'query_type': 'incidencia_consulta', 'ubicacion': 'madrid'}
2025-06-20 12:51:16,303 - INFO - User message: Incidencias en madrid
2025-06-20 12:51:16,304 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-20 12:51:16,304 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-c36f79af-c058-4f34-89a2-a74d44f4f0fa', 'json_data': {'messages': [{'role': 'system', 'content': "Eres un agente especializado en gesti�n de incidencias. **No inventes datos**; extrae el DNI o ID de incidencia y llama a la herramienta correcta. Presenta s�lo los datos reales obtenidos de la API. No llames a herramientas de abonado como direccion_abonado para consultas de incidencias. \n\nCuando te pregunten por una ubicaci�n, usa siempre incidencias_por_ubicacion. Si la pregunta es referencial (ejemplo: 'Y en Barcelona?'), significa que el usuario quiere consultar las incidencias en esa nueva ubicaci�n. Aseg�rate de que las consultas referenciales con ubicaci�n generen siempre una llamada a la herramienta adecuada."}, {'role': 'user', 'content': 'Incidencias en madrid'}], 'model': 'llama-3.1-8b-instant', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': 'Herramienta para existe_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': 'Herramienta para direccion_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': 'Herramienta para estado_pagos', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': 'Herramienta para ultimo_pago', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': 'Herramienta para deuda_total', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': 'Herramienta para facturas_pendientes', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': 'Herramienta para todas_las_facturas', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': 'Herramienta para datos_abonado', 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': 'Herramienta para crear_incidencia', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': 'Herramienta para incidencias_por_dni', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': 'Herramienta para incidencias_por_nombre', 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': 'Herramienta para actualizar_estado_incidencia', 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': 'Herramienta para incidencias_pendientes', 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': 'Herramienta para incidencias_por_ubicacion', 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': 'Herramienta para herramientas_disponibles', 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-20 12:51:16,305 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-20 12:51:16,305 - DEBUG - close.started
2025-06-20 12:51:16,305 - DEBUG - close.complete
2025-06-20 12:51:16,305 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:51:16,359 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D186620>
2025-06-20 12:51:16,359 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002309D199A30> server_hostname='api.groq.com' timeout=5.0
2025-06-20 12:51:16,391 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D28DD10>
2025-06-20 12:51:16,391 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:51:16,391 - DEBUG - send_request_headers.complete
2025-06-20 12:51:16,391 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:51:16,391 - DEBUG - send_request_body.complete
2025-06-20 12:51:16,391 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:51:16,681 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Fri, 20 Jun 2025 10:51:16 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'14400'), (b'x-ratelimit-limit-tokens', b'6000'), (b'x-ratelimit-remaining-requests', b'14399'), (b'x-ratelimit-remaining-tokens', b'2977'), (b'x-ratelimit-reset-requests', b'6s'), (b'x-ratelimit-reset-tokens', b'30.228s'), (b'x-request-id', b'req_01jy6fdnk4f6g8r9384gp5vd0k'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'952ab5c3a861ec93-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-20 12:51:16,681 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-20 12:51:16,681 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:51:16,681 - DEBUG - receive_response_body.complete
2025-06-20 12:51:16,681 - DEBUG - response_closed.started
2025-06-20 12:51:16,681 - DEBUG - response_closed.complete
2025-06-20 12:51:16,681 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Fri, 20 Jun 2025 10:51:16 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '14400', 'x-ratelimit-limit-tokens': '6000', 'x-ratelimit-remaining-requests': '14399', 'x-ratelimit-remaining-tokens': '2977', 'x-ratelimit-reset-requests': '6s', 'x-ratelimit-reset-tokens': '30.228s', 'x-request-id': 'req_01jy6fdnk4f6g8r9384gp5vd0k', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '952ab5c3a861ec93-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-20 12:51:16,682 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='rmhs9phnc', function=Function(arguments='{"ubicacion":"Madrid"}', name='incidencias_por_ubicacion'), type='function')])
2025-06-20 12:51:16,682 - INFO - Executing tool: incidencias_por_ubicacion with args: {'ubicacion': 'Madrid'}
2025-06-20 12:51:17,178 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:51:19,210 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D28E030>
2025-06-20 12:51:19,210 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:51:19,211 - DEBUG - send_request_headers.complete
2025-06-20 12:51:19,211 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:51:19,211 - DEBUG - send_request_body.complete
2025-06-20 12:51:19,211 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:51:19,214 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Fri, 20 Jun 2025 10:51:19 GMT'), (b'server', b'uvicorn'), (b'content-length', b'109'), (b'content-type', b'application/json')])
2025-06-20 12:51:19,215 - INFO - HTTP Request: POST http://localhost:8000/incidencias_por_ubicacion "HTTP/1.1 200 OK"
2025-06-20 12:51:19,215 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:51:19,215 - DEBUG - receive_response_body.complete
2025-06-20 12:51:19,215 - DEBUG - response_closed.started
2025-06-20 12:51:19,215 - DEBUG - response_closed.complete
2025-06-20 12:51:19,215 - DEBUG - close.started
2025-06-20 12:51:19,215 - DEBUG - close.complete
2025-06-20 12:51:19,215 - INFO - Raw tool response for incidencias_por_ubicacion: {'incidencias': [{'ubicacion': 'Madrid', 'descripcion': 'Fallo en el suministro el�ctrico', 'estado': 'Abierto'}]}
2025-06-20 12:51:19,215 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-20 12:51:19,215 - INFO - Final Markdown content: ### Incidencias
**Resumen:**
- Total: 1 incidencia(s)
- Abiertas: 1
- En proceso: 0
- Resueltas: 0

#### Detalles
| Ubicaci�n | Descripci�n | Estado |
|:----------|:------------|:-------|
| Madrid | Fallo en el suministro el�ctrico | Abierto |
2025-06-20 12:51:24,740 - DEBUG - Context after update: {'last_message': 'y en barcelona?', 'requires_real_data': False, 'is_referential': True, 'query_type': 'incidencia_consulta', 'ubicacion': 'madrid'}
2025-06-20 12:51:24,740 - INFO - User message: y en barcelona?
2025-06-20 12:51:24,740 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-20 12:51:24,741 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-334d53a6-a2e5-4ca3-ac1c-acab24fc0bbe', 'json_data': {'messages': [{'role': 'system', 'content': 'Eres un asistente general. Responde preguntas comunes sin inventar datos. Si no aplican herramientas espec�ficas, responde con conocimiento general. Utiliza siempre el contexto disponible (como DNI, tipo de consulta, etc.) para responder o realizar llamadas a herramientas, especialmente en consultas referenciales.'}, {'role': 'user', 'content': 'y en barcelona?'}], 'model': 'llama-3.1-8b-instant', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': 'Herramienta para existe_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': 'Herramienta para direccion_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': 'Herramienta para estado_pagos', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': 'Herramienta para ultimo_pago', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': 'Herramienta para deuda_total', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': 'Herramienta para facturas_pendientes', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': 'Herramienta para todas_las_facturas', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': 'Herramienta para datos_abonado', 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': 'Herramienta para crear_incidencia', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': 'Herramienta para incidencias_por_dni', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': 'Herramienta para incidencias_por_nombre', 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': 'Herramienta para actualizar_estado_incidencia', 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': 'Herramienta para incidencias_pendientes', 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': 'Herramienta para incidencias_por_ubicacion', 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': 'Herramienta para herramientas_disponibles', 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-20 12:51:24,741 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-20 12:51:24,741 - DEBUG - close.started
2025-06-20 12:51:24,742 - DEBUG - close.complete
2025-06-20 12:51:24,742 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:51:24,778 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D285370>
2025-06-20 12:51:24,778 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002309D199A30> server_hostname='api.groq.com' timeout=5.0
2025-06-20 12:51:24,807 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D2531D0>
2025-06-20 12:51:24,807 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:51:24,808 - DEBUG - send_request_headers.complete
2025-06-20 12:51:24,808 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:51:24,808 - DEBUG - send_request_body.complete
2025-06-20 12:51:24,808 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:51:25,090 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Fri, 20 Jun 2025 10:51:25 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'14400'), (b'x-ratelimit-limit-tokens', b'6000'), (b'x-ratelimit-remaining-requests', b'14399'), (b'x-ratelimit-remaining-tokens', b'2365'), (b'x-ratelimit-reset-requests', b'6s'), (b'x-ratelimit-reset-tokens', b'36.346s'), (b'x-request-id', b'req_01jy6fdxtteze8psvsn7dyfvq1'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'952ab5f8495b0331-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-20 12:51:25,090 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-20 12:51:25,090 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:51:25,090 - DEBUG - receive_response_body.complete
2025-06-20 12:51:25,090 - DEBUG - response_closed.started
2025-06-20 12:51:25,091 - DEBUG - response_closed.complete
2025-06-20 12:51:25,091 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Fri, 20 Jun 2025 10:51:25 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '14400', 'x-ratelimit-limit-tokens': '6000', 'x-ratelimit-remaining-requests': '14399', 'x-ratelimit-remaining-tokens': '2365', 'x-ratelimit-reset-requests': '6s', 'x-ratelimit-reset-tokens': '36.346s', 'x-request-id': 'req_01jy6fdxtteze8psvsn7dyfvq1', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '952ab5f8495b0331-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-20 12:51:25,091 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='w1zabs6dn', function=Function(arguments='null', name='herramientas_disponibles'), type='function')])
2025-06-20 12:51:25,091 - ERROR - Arguments for function herramientas_disponibles are None. Skipping execution.
2025-06-20 12:51:25,091 - INFO - Final response prepared: 
2025-06-20 12:51:36,284 - DEBUG - Context after update: {'last_message': 'Y en barcelona?', 'requires_real_data': False, 'is_referential': True, 'query_type': 'incidencia_consulta', 'ubicacion': 'madrid'}
2025-06-20 12:51:36,284 - INFO - User message: Y en barcelona?
2025-06-20 12:51:36,284 - INFO - Sending initial request to LLM with tool_choice='auto'...
2025-06-20 12:51:36,285 - DEBUG - Request options: {'method': 'post', 'url': '/openai/v1/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-40b7669a-590a-4627-bcf1-906f57f29d53', 'json_data': {'messages': [{'role': 'system', 'content': "Eres un agente especializado en gesti�n de incidencias. **No inventes datos**; extrae el DNI o ID de incidencia y llama a la herramienta correcta. Presenta s�lo los datos reales obtenidos de la API. No llames a herramientas de abonado como direccion_abonado para consultas de incidencias. \n\nCuando te pregunten por una ubicaci�n, usa siempre incidencias_por_ubicacion. Si la pregunta es referencial (ejemplo: 'Y en Barcelona?'), significa que el usuario quiere consultar las incidencias en esa nueva ubicaci�n. Aseg�rate de que las consultas referenciales con ubicaci�n generen siempre una llamada a la herramienta adecuada."}, {'role': 'user', 'content': 'Y en barcelona?'}], 'model': 'llama-3.1-8b-instant', 'tool_choice': 'auto', 'tools': [{'type': 'function', 'function': {'name': 'existe_abonado', 'description': 'Herramienta para existe_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_existe_abonado'}}, 'endpoint': '/existe_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'direccion_abonado', 'description': 'Herramienta para direccion_abonado', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_direccion_abonado'}}, 'endpoint': '/direccion_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'estado_pagos', 'description': 'Herramienta para estado_pagos', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_estado_pagos'}}, 'endpoint': '/estado_pagos', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'ultimo_pago', 'description': 'Herramienta para ultimo_pago', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_ultimo_pago'}}, 'endpoint': '/ultimo_pago', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'deuda_total', 'description': 'Herramienta para deuda_total', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_deuda_total'}}, 'endpoint': '/deuda_total', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'facturas_pendientes', 'description': 'Herramienta para facturas_pendientes', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_facturas_pendientes'}}, 'endpoint': '/facturas_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'todas_las_facturas', 'description': 'Herramienta para todas_las_facturas', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_todas_las_facturas'}}, 'endpoint': '/todas_las_facturas', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'datos_abonado', 'description': 'Herramienta para datos_abonado', 'parameters': {'properties': {'dni': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Dni'}, 'poliza': {'anyOf': [{'type': 'string'}, {'type': 'null'}], 'title': 'Poliza'}}, 'type': 'object', 'title': 'DatosAbonadoInput'}}, 'endpoint': '/datos_abonado', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'crear_incidencia', 'description': 'Herramienta para crear_incidencia', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}, 'ubicacion': {'type': 'string', 'title': 'Ubicacion'}, 'descripcion': {'type': 'string', 'title': 'Descripcion'}, 'estado': {'type': 'string', 'title': 'Estado', 'default': 'Abierto'}}, 'type': 'object', 'required': ['dni', 'ubicacion', 'descripcion'], 'title': 'Body_crear_incidencia'}}, 'endpoint': '/crear_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_dni', 'description': 'Herramienta para incidencias_por_dni', 'parameters': {'properties': {'dni': {'type': 'string', 'title': 'Dni'}}, 'type': 'object', 'required': ['dni'], 'title': 'Body_incidencias_por_dni'}}, 'endpoint': '/incidencias_por_dni', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_nombre', 'description': 'Herramienta para incidencias_por_nombre', 'parameters': {'properties': {'nombre': {'type': 'string', 'title': 'Nombre'}}, 'type': 'object', 'required': ['nombre'], 'title': 'Body_incidencias_por_nombre'}}, 'endpoint': '/incidencias_por_nombre', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'actualizar_estado_incidencia', 'description': 'Herramienta para actualizar_estado_incidencia', 'parameters': {'properties': {'incidencia_id': {'type': 'integer', 'title': 'Incidencia Id'}, 'nuevo_estado': {'type': 'string', 'title': 'Nuevo Estado'}}, 'type': 'object', 'required': ['incidencia_id', 'nuevo_estado'], 'title': 'Body_actualizar_estado_incidencia'}}, 'endpoint': '/actualizar_estado_incidencia', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_pendientes', 'description': 'Herramienta para incidencias_pendientes', 'parameters': {}}, 'endpoint': '/incidencias_pendientes', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'incidencias_por_ubicacion', 'description': 'Herramienta para incidencias_por_ubicacion', 'parameters': {'properties': {'ubicacion': {'type': 'string', 'title': 'Ubicacion'}}, 'type': 'object', 'required': ['ubicacion'], 'title': 'Body_incidencias_por_ubicacion'}}, 'endpoint': '/incidencias_por_ubicacion', 'method': 'POST'}, {'type': 'function', 'function': {'name': 'herramientas_disponibles', 'description': 'Herramienta para herramientas_disponibles', 'parameters': {}}, 'endpoint': '/herramientas_disponibles', 'method': 'GET'}]}}
2025-06-20 12:51:36,286 - DEBUG - Sending HTTP Request: POST https://api.groq.com/openai/v1/chat/completions
2025-06-20 12:51:36,286 - DEBUG - close.started
2025-06-20 12:51:36,286 - DEBUG - close.complete
2025-06-20 12:51:36,286 - DEBUG - connect_tcp.started host='api.groq.com' port=443 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:51:36,343 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D2ABED0>
2025-06-20 12:51:36,343 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002309D199A30> server_hostname='api.groq.com' timeout=5.0
2025-06-20 12:51:36,397 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D299320>
2025-06-20 12:51:36,398 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:51:36,398 - DEBUG - send_request_headers.complete
2025-06-20 12:51:36,398 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:51:36,398 - DEBUG - send_request_body.complete
2025-06-20 12:51:36,398 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:51:36,694 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Fri, 20 Jun 2025 10:51:36 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Cache-Control', b'private, max-age=0, no-store, no-cache, must-revalidate'), (b'vary', b'Origin'), (b'x-groq-region', b'gcp-europe-west3'), (b'x-ratelimit-limit-requests', b'14400'), (b'x-ratelimit-limit-tokens', b'6000'), (b'x-ratelimit-remaining-requests', b'14399'), (b'x-ratelimit-remaining-tokens', b'2004'), (b'x-ratelimit-reset-requests', b'6s'), (b'x-ratelimit-reset-tokens', b'39.955s'), (b'x-request-id', b'req_01jy6fe94nezwtjccwsvzdvz91'), (b'cf-cache-status', b'DYNAMIC'), (b'Server', b'cloudflare'), (b'CF-RAY', b'952ab640bcb8cc3c-MAD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-20 12:51:36,695 - INFO - HTTP Request: POST https://api.groq.com/openai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-20 12:51:36,695 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:51:36,695 - DEBUG - receive_response_body.complete
2025-06-20 12:51:36,695 - DEBUG - response_closed.started
2025-06-20 12:51:36,695 - DEBUG - response_closed.complete
2025-06-20 12:51:36,695 - DEBUG - HTTP Response: POST https://api.groq.com/openai/v1/chat/completions "200 OK" Headers({'date': 'Fri, 20 Jun 2025 10:51:36 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'cache-control': 'private, max-age=0, no-store, no-cache, must-revalidate', 'vary': 'Origin', 'x-groq-region': 'gcp-europe-west3', 'x-ratelimit-limit-requests': '14400', 'x-ratelimit-limit-tokens': '6000', 'x-ratelimit-remaining-requests': '14399', 'x-ratelimit-remaining-tokens': '2004', 'x-ratelimit-reset-requests': '6s', 'x-ratelimit-reset-tokens': '39.955s', 'x-request-id': 'req_01jy6fe94nezwtjccwsvzdvz91', 'cf-cache-status': 'DYNAMIC', 'server': 'cloudflare', 'cf-ray': '952ab640bcb8cc3c-MAD', 'content-encoding': 'gzip', 'alt-svc': 'h3=":443"; ma=86400'})
2025-06-20 12:51:36,696 - INFO - Received response: ChatCompletionMessage(content=None, role='assistant', executed_tools=None, function_call=None, reasoning=None, tool_calls=[ChatCompletionMessageToolCall(id='rfpk59rdd', function=Function(arguments='{"ubicacion":"Barcelona"}', name='incidencias_por_ubicacion'), type='function')])
2025-06-20 12:51:36,696 - INFO - Executing tool: incidencias_por_ubicacion with args: {'ubicacion': 'Barcelona'}
2025-06-20 12:51:37,159 - DEBUG - connect_tcp.started host='localhost' port=8000 local_address=None timeout=5.0 socket_options=None
2025-06-20 12:51:39,194 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002309D299860>
2025-06-20 12:51:39,194 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-20 12:51:39,195 - DEBUG - send_request_headers.complete
2025-06-20 12:51:39,195 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-20 12:51:39,195 - DEBUG - send_request_body.complete
2025-06-20 12:51:39,195 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-20 12:51:39,199 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'date', b'Fri, 20 Jun 2025 10:51:38 GMT'), (b'server', b'uvicorn'), (b'content-length', b'185'), (b'content-type', b'application/json')])
2025-06-20 12:51:39,199 - INFO - HTTP Request: POST http://localhost:8000/incidencias_por_ubicacion "HTTP/1.1 200 OK"
2025-06-20 12:51:39,199 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-20 12:51:39,199 - DEBUG - receive_response_body.complete
2025-06-20 12:51:39,199 - DEBUG - response_closed.started
2025-06-20 12:51:39,199 - DEBUG - response_closed.complete
2025-06-20 12:51:39,200 - DEBUG - close.started
2025-06-20 12:51:39,200 - DEBUG - close.complete
2025-06-20 12:51:39,200 - INFO - Raw tool response for incidencias_por_ubicacion: {'incidencias': [{'ubicacion': 'Barcelona', 'descripcion': 'Problema con la factura', 'estado': 'Resuelto'}, {'ubicacion': 'Barcelona', 'descripcion': 'fallo en el servicio', 'estado': 'Abierto'}]}
2025-06-20 12:51:39,200 - INFO - Final response prepared (tool_call only, markdown returned).
2025-06-20 12:51:39,200 - INFO - Final Markdown content: ### Incidencias
**Resumen:**
- Total: 2 incidencia(s)
- Abiertas: 1
- En proceso: 0
- Resueltas: 1

#### Detalles
| Ubicaci�n | Descripci�n | Estado |
|:----------|:------------|:-------|
| Barcelona | fallo en el servicio | Abierto |
| Barcelona | Problema con la factura | Resuelto |
2025-06-20 12:51:57,648 - DEBUG - close.started
2025-06-20 12:51:57,650 - DEBUG - close.complete
